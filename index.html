<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Flashcards (Pro Mode)</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Noto+Sans+TC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6c5ce7; --primary-dark: #5b4cc4; 
            --secondary: #00cec9; --accent: #fd79a8;
            --success: #00b894; --warning: #fdcb6e; --danger: #ff7675; --danger-dark: #d63031;
            --text: #2d3436; --text-light: #636e72;
            --card-bg: rgba(255, 255, 255, 0.95);
            --shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Noto Sans TC', 'Fredoka', sans-serif;
            background: linear-gradient(-45deg, #74b9ff, #a29bfe, #81ecec, #fab1a0);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            margin: 0; padding: 20px;
            color: var(--text);
            display: flex; justify-content: center;
            min-height: 100vh;
            overflow-x: hidden;
        }
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        .container { width: 100%; max-width: 550px; position: relative; z-index: 10; padding-bottom: 50px;}
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999; }
        #combo-layer { position: fixed; top: 20%; left: 50%; transform: translateX(-50%); z-index: 2000; pointer-events: none; text-align: center; width: 100%; }

        /* --- Combo --- */
        .combo-text {
            font-family: 'Fredoka', sans-serif; font-weight: 800; font-style: italic;
            position: absolute; width: 100%; left: 0;
            text-shadow: 3px 3px 0 #fff, 0 0 10px rgba(0,0,0,0.1);
            animation: comboPop 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; opacity: 0;
        }
        .combo-small { font-size: 2.5em; color: var(--secondary); }
        .combo-medium { font-size: 3.5em; color: var(--warning); text-shadow: 3px 3px 0 #fff, 0 0 15px var(--warning); }
        .combo-large { font-size: 4.5em; color: var(--danger); text-shadow: 4px 4px 0 #fff, 0 0 20px var(--danger); transform: rotate(-10deg); }
        @keyframes comboPop { 0% { transform: scale(0.5) translateY(50px); opacity: 0; } 50% { transform: scale(1.2) translateY(0); opacity: 1; } 100% { transform: scale(1) translateY(-80px); opacity: 0; } }

        /* --- UI --- */
        button { cursor: pointer; border: none; border-radius: 12px; font-family: inherit; font-weight: 600; transition: all 0.2s; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        button:active { transform: scale(0.96); box-shadow: none; }
        .btn-primary { background: var(--primary); color: white; padding: 12px 20px; box-shadow: 0 4px 10px rgba(108, 92, 231, 0.3); }
        .btn-success { background: var(--success); color: white; padding: 12px; }
        .btn-danger { background: var(--danger); color: white; padding: 5px 12px; font-size: 0.85em; border-radius: 20px;}
        .btn-warning { background: var(--warning); color: #333; padding: 12px; }
        .btn-outline { background: rgba(255,255,255,0.8); border: 2px solid transparent; color: var(--text); padding: 8px 16px; backdrop-filter: blur(5px); }
        .btn-outline:hover { background: white; border-color: var(--primary); color: var(--primary); }
        .btn-block { width: 100%; padding: 14px; font-size: 1.1em; }
        .btn-duel { 
            background: linear-gradient(135deg, #74b9ff, #0984e3); color: white; 
            padding: 6px 10px; border-radius: 8px; font-size: 0.85em; 
            box-shadow: 0 4px 10px rgba(9, 132, 227, 0.3); width: 100%; margin-top: 8px; 
        }
        .btn-ocr { background: linear-gradient(135deg, #fab1a0, #ff7675); color: white; width: 100%; padding: 14px; margin-bottom: 15px; border-radius: 15px; font-size: 1.1em; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 5px 15px rgba(255, 118, 117, 0.3); }

        .card-area { background: var(--card-bg); border-radius: 24px; box-shadow: var(--shadow); padding: 30px; text-align: center; min-height: 400px; display: flex; flex-direction: column; justify-content: center; position: relative; border: 1px solid rgba(255,255,255,0.5); backdrop-filter: blur(10px); transition: transform 0.3s; }
        
        .group-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }
        .group-card { 
            background: rgba(255, 255, 255, 0.9); padding: 12px; border-radius: 16px;
            box-shadow: 0 5px 10px rgba(0,0,0,0.05); cursor: pointer; transition: 0.3s; 
            border: 2px solid transparent; display: flex; flex-direction: column; justify-content: space-between; 
            min-height: 130px;
        }
        .group-card:hover { transform: translateY(-5px); border-color: var(--primary); background: white; box-shadow: 0 10px 25px rgba(108, 92, 231, 0.15); }

        .card-header-row { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .card-title-text { font-size: 1.1em; color: var(--primary); margin: 0; font-weight: bold; word-break: break-word; flex: 1; text-align: left; line-height: 1.2;}
        .card-tools { display: flex; gap: 4px; flex-shrink: 0; margin-left: 5px; }
        .tool-btn { 
            width: 26px; height: 26px; border-radius: 6px; display: flex; align-items: center; justify-content: center; 
            font-size: 0.9em; background: #fff; border: 1px solid #eee; color: #555; transition: 0.2s;
        }
        .tool-btn:hover { background: var(--primary); color: white; border-color: var(--primary); }
        .tool-btn.danger:hover { background: var(--danger); color: white; border-color: var(--danger); }

        .view { display: none; opacity: 0; transform: scale(0.95); transition: opacity 0.3s, transform 0.3s; }
        .view.active { display: block; opacity: 1; transform: scale(1); animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { opacity: 0; transform: scale(0.95) translateY(10px); } to { opacity: 1; transform: scale(1) translateY(0); } }

        .nav-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        /* ç½®ä¸­å°è¦½åˆ— (Center Nav Bar) */
        .nav-bar-center { position: relative; justify-content: center; }
        .nav-bar-center .btn-outline { position: absolute; left: 0; top: 50%; transform: translateY(-50%); }
        .nav-bar-title { font-weight: bold; font-size: 1.2em; text-align: center; }

        .chinese-meaning { font-size: 2em; font-weight: 700; color: var(--text); margin: 25px 0; letter-spacing: 1px; }
        .sentence { background: rgba(108, 92, 231, 0.05); padding: 20px; border-left: 5px solid var(--primary); border-radius: 8px; margin-bottom: 25px; color: var(--text-light); font-style: italic; line-height: 1.6; text-align: left; }
        
        .input-area { display: flex; justify-content: center; margin: 15px 0; }
        .input-area input { 
            width: 80%; max-width: 320px;
            padding: 12px 20px; margin: 0; 
            border: 2px solid #dfe6e9; border-radius: 50px; 
            font-size: 1.4em; text-align: center; font-weight: bold; 
            color: var(--primary); background: #fdfdfd; 
            transition: all 0.3s; letter-spacing: 2px;
            box-shadow: inset 0 2px 5px rgba(0,0,0,0.03);
        }
        .input-area input:focus { border-color: var(--primary); background: white; box-shadow: 0 4px 15px rgba(108, 92, 231, 0.15); outline: none; width: 90%; }
        .input-area input.correct { border-color: var(--success); background-color: #e8f8f5; color: var(--success); }
        .input-area input.wrong { border-color: var(--danger); background-color: #ffecec; color: var(--danger); animation: shake 0.4s; }

        .mic-container { position: relative; width: 80px; height: 80px; margin: 0 auto 20px auto; }
        .mic-btn {
            width: 80px; height: 80px; border-radius: 50%;
            background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white; font-size: 2.5em; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 5px 15px rgba(108, 92, 231, 0.4); z-index: 2; position: relative; border: 2px solid white; cursor: pointer; transition: 0.3s;
        }
        .mic-btn:hover { transform: scale(1.05); }
        .mic-btn.listening { background: linear-gradient(135deg, #ff7675, #d63031); animation: pulseMic 1.5s infinite; }
        .mic-ring {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%;
            background: rgba(108, 92, 231, 0.2); z-index: 1; opacity: 0;
        }
        .mic-btn.listening + .mic-ring { animation: ripple 1.5s infinite; }
        
        .score-box { margin-top: 15px; padding: 15px; background: #f8f9fa; border-radius: 12px; border: 1px solid #eee; display: none; animation: popIn 0.3s; }
        .score-bar-bg { height: 10px; background: #e0e0e0; border-radius: 5px; overflow: hidden; margin: 10px 0; }
        .score-bar-fill { height: 100%; background: var(--success); width: 0%; transition: width 1s ease-out; }
        
        @keyframes pulseMic { 0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 118, 117, 0.7); } 70% { transform: scale(1.05); box-shadow: 0 0 0 15px rgba(255, 118, 117, 0); } 100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(255, 118, 117, 0); } }
        @keyframes ripple { 0% { transform: scale(1); opacity: 0.8; } 100% { transform: scale(2); opacity: 0; } }

        .spell-audio-btn {
            width: 70px; height: 70px; border-radius: 50%;
            background: linear-gradient(145deg, #ffffff, #e6e6e6);
            border: 1px solid #fff;
            box-shadow: 5px 5px 15px #d1d1d1, -5px -5px 15px #ffffff;
            font-size: 2em; color: var(--primary);
            margin: 0 auto 10px auto;
            display: flex; align-items: center; justify-content: center;
        }
        .spell-audio-btn:active { box-shadow: inset 5px 5px 10px #d1d1d1, inset -5px -5px 10px #ffffff; transform: scale(0.98); }

        .battle-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 25px; }
        .health-bar-container { width: 42%; }
        .health-bar-container.opponent { text-align: right; }
        .health-track { width: 100%; height: 12px; background: #dfe6e9; margin-top: 8px; border-radius: 10px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0,0,0,0.1); }
        .health-fill { height: 100%; background: linear-gradient(90deg, #00b894, #00cec9); width: 100%; transition: width 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); border-radius: 10px; }
        .health-fill.danger { background: linear-gradient(90deg, #ff7675, #d63031); animation: pulseBar 1s infinite; }
        .avatar { font-size: 2.5em; display: block; filter: drop-shadow(0 4px 4px rgba(0,0,0,0.1)); animation: floatAvatar 3s ease-in-out infinite; }
        @keyframes floatAvatar { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
        @keyframes pulseBar { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-8px); } 75% { transform: translateX(8px); } }

        .danger-zone { margin-top: 40px; padding: 20px; border: 2px dashed rgba(255, 118, 117, 0.5); border-radius: 16px; text-align: center; background: rgba(255, 255, 255, 0.4); }
        .btn-reset-big { background: linear-gradient(135deg, #ff7675, #d63031); color: white; font-weight: bold; font-size: 1.1em; width: 100%; padding: 15px; border-radius: 12px; display: flex; align-items: center; justify-content: center; gap: 10px; box-shadow: 0 4px 15px rgba(214, 48, 49, 0.3); transition: 0.2s; }
        .btn-reset-big:hover { transform: scale(1.02); box-shadow: 0 6px 20px rgba(214, 48, 49, 0.4); }

        /* --- Modal & Settings --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.3); backdrop-filter: blur(5px); display: none; justify-content: center; align-items: center; z-index: 1000; }
        /* Default modal is centered */
        .modal { background: white; padding: 25px; border-radius: 24px; width: 360px; text-align: center; box-shadow: 0 20px 50px rgba(0,0,0,0.2); max-height: 90vh; overflow-y: auto;}
        
        /* Helper for left-aligned settings */
        .text-left { text-align: left; }

        .settings-section-title { font-weight: bold; color: var(--primary); font-size: 1em; margin: 15px 0 10px 0; display:flex; align-items:center; gap:6px; }
        
        .mode-options { display: flex; gap: 8px; margin-bottom: 25px; }
        .mode-opt { flex: 1; cursor: pointer; position: relative; }
        .mode-opt input { position: absolute; opacity: 0; cursor: pointer; }
        .mode-label { 
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            padding: 8px 4px; border: 2px solid #f0f0f0; border-radius: 12px; 
            background: #fff; color: #888; transition: 0.2s; height: 100%;
        }
        .mode-opt input:checked + .mode-label {
            border-color: var(--primary); background: #f0edff; color: var(--primary); font-weight: bold;
            box-shadow: 0 4px 8px rgba(108, 92, 231, 0.15); transform: translateY(-2px);
        }
        .mode-label span { font-size: 1.2em; margin-bottom: 3px; }
        .mode-label div { font-size: 0.75em; }

        .sm2-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; background: #f8f9fa; padding: 15px; border-radius: 15px; border:1px solid #eee; }
        .sm2-item { background: white; padding: 10px; border-radius: 10px; border: 1px solid #e0e0e0; text-align: center; }
        .sm2-item label { display: block; font-size: 0.75em; color: #aaa; margin-bottom: 4px; text-transform: uppercase; letter-spacing: 0.5px; }
        .sm2-item input { width: 100%; border: none; font-size: 1.3em; font-weight: bold; color: var(--text); text-align: center; background: transparent; padding: 0; font-family: 'Fredoka', sans-serif; }
        .sm2-item input:focus { outline: none; color: var(--primary); }

        .add-group-card { border: 2px dashed #b2bec3; background: transparent; color: #b2bec3; }
        .add-group-card:hover { border-color: var(--primary); color: var(--primary); background: rgba(108, 92, 231, 0.05); }
        #join-id-input { width: 80%; max-width: 260px; margin: 0 auto 20px auto; display: block; padding: 15px; font-size: 1.2em; text-align: center; letter-spacing: 1px; border: 2px solid #e0e0e0; border-radius: 12px; background: #f8f9fa; }
        #join-id-input:focus { border-color: var(--primary); background: white; }
        
        .top-action-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px; padding: 5px 0; }
        .user-info-group { display: flex; align-items: center; gap: 8px; }
        .action-buttons-group { display: flex; align-items: center; gap: 10px; }
        .mode-badge { font-size: 0.85em; color: var(--text-light); background: rgba(255,255,255,0.6); padding: 6px 12px; border-radius: 20px; backdrop-filter: blur(5px); box-shadow: 0 2px 5px rgba(0,0,0,0.05); border: 1px solid rgba(255,255,255,0.8); }
    </style>
</head>
<body>

<canvas id="confetti-canvas"></canvas>
<div id="combo-layer"></div>

<div class="container">
    
    <div id="view-dashboard" class="view active">
        <div class="top-action-bar">
            <div class="user-info-group">
                <span id="user-greeting" style="font-family:'Fredoka', sans-serif; font-size: 1.5em; font-weight: 600; color: var(--primary); text-shadow: 2px 2px 0px rgba(255,255,255,0.5);">Hi, Student</span>
                <button class="btn-outline" style="padding: 4px 8px; border-radius: 50%; width:30px; height:30px;" onclick="editUserName()">âœ</button>
            </div>
            
            <div class="action-buttons-group">
                 <div class="mode-badge">
                    æ¨¡å¼: <span id="current-mode-display" style="font-weight:bold; color:var(--primary);">ç¿»å¡</span>
                 </div>
                 <button class="btn-outline" onclick="openJoinLobby()" title="åŠ å…¥å°æˆ°">âš”ï¸</button>
                 <button class="btn-outline" onclick="showModal('settings')" title="è¨­å®š">âš™ï¸</button>
            </div>
        </div>

        <div class="group-grid" id="group-grid-display"></div>
        
        <div style="margin-top: 30px; display: flex; gap: 10px; justify-content: center;">
             <button class="btn-outline" onclick="triggerImport()" style="font-size:0.9em;">ğŸ“‚ åŒ¯å…¥ (.json)</button>
             <input type="file" id="file-import" style="display: none;" accept=".json" onchange="handleImport(event)">
             <button class="btn-outline" onclick="sendGmailReminder()" style="font-size:0.9em;">ğŸ“§ Gmail æé†’</button>
        </div>
        
        <div class="danger-zone">
            <div style="font-size:0.8em; color:var(--danger-dark); margin-bottom:10px; font-weight:bold;">âš ï¸ å±éšªæ“ä½œå€</div>
            <button class="btn-reset-big" onclick="factoryReset()">
                <span>ğŸ—‘ï¸ æ¸…é™¤æ‰€æœ‰è³‡æ–™ (Reset)</span>
            </button>
            <div style="font-size:0.75em; color:#888; margin-top:8px;">æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼Œè«‹è¬¹æ…ä½¿ç”¨</div>
        </div>
    </div>

    <div id="view-workspace" class="view">
        <div class="nav-bar">
            <button class="btn-outline" onclick="goDashboard()">â† è¿”å›</button>
            <span id="current-group-name" style="font-weight: 700; color: var(--primary); font-size:1.1em;"></span>
            <button class="btn-outline" onclick="openManager()">ğŸ“ ç®¡ç†</button>
        </div>
        
        <button class="btn-primary btn-block" onclick="toggleMode()" id="mode-btn" style="margin-bottom: 20px; background: linear-gradient(135deg, #a29bfe, #6c5ce7);">âœ¨ AI æ™ºèƒ½æ–°å¢</button>

        <div id="mode-study">
            <div style="text-align: center; margin-bottom: 15px; color: var(--text-light); font-size: 0.9em; font-weight: 600;">
                <span id="study-mode-label" style="background:#e0e0e0; color:#555; padding:2px 8px; border-radius:10px; font-size:0.8em; margin-right:5px;">ç¿»å¡</span>
                å¾…è¤‡ç¿’: <span id="count-due" style="color:var(--primary);">0</span> &nbsp;|&nbsp; 
                éŒ¯èª¤: <span id="count-retry" style="color:var(--danger);">0</span>
            </div>
            <div class="card-area" id="card-display"></div>
        </div>

        <div id="mode-add" style="display: none;">
            <div class="card-area" style="text-align: left; justify-content: flex-start;">
                <h3 style="text-align:center; color:var(--primary);">ğŸ¤– Gemini 2.5 Flash</h3>
                <button class="btn-ocr" id="btn-upload-img" onclick="triggerImageUpload()">ğŸ“¸ æ‹ç…§ / æƒæå–®å­—</button>
                <input type="file" id="img-input" style="display:none;" accept="image/*" onchange="handleImageSelect(event)">
                <div id="img-preview-container" style="display:none; text-align:center; margin:10px 0;">
                    <img id="img-preview" src="" alt="Preview" style="max-height:150px; border-radius:10px; box-shadow:0 4px 10px rgba(0,0,0,0.1);">
                    <div style="color:var(--danger); cursor:pointer; font-size:0.9em; margin-top:5px;" onclick="clearImage()">ç§»é™¤åœ–ç‰‡</div>
                </div>
                
                <label style="font-weight:bold; font-size:0.9em; color:#666;">API Key</label>
                <input type="password" id="api-key" placeholder="Paste Gemini Key" style="width:100%; padding:12px; margin:5px 0 15px 0; border:1px solid #ddd; border-radius:10px; box-sizing:border-box;">
                
                <label style="font-weight:bold; font-size:0.9em; color:#666;">è¼¸å…¥è‹±æ–‡å–®å­—</label>
                <textarea id="words-input" rows="4" placeholder="ä¾‹å¦‚: resilience, epiphany..." style="width:100%; padding:12px; border:1px solid #ddd; border-radius:10px; box-sizing:border-box; font-family:inherit;"></textarea>
                
                <button class="btn-primary btn-block" onclick="generateCards()" style="margin-top: 20px;">ğŸš€ ç”Ÿæˆä¸¦å¯©æ ¸</button>
                <div id="loading-msg" style="display:none; text-align:center; color: var(--primary); margin-top:15px; font-weight:bold;">AI æ­£åœ¨åˆ†æä¸­...</div>
            </div>
        </div>
    </div>

    <div id="view-review" class="view">
        <div class="nav-bar"><span style="font-weight: bold;">ğŸ§ å¯©æ ¸ AI å–®å­—</span></div>
        <div class="card-area" style="text-align: left; padding: 20px; display:block; overflow:visible;">
            <p style="font-size:0.9em; color:#666; text-align:center;">ç¢ºèªç„¡èª¤å¾Œé»æ“ŠåŒ¯å…¥</p>
            <div id="review-list" style="max-height:400px; overflow-y:auto; padding-right:5px;"></div>
            <div style="margin-top:20px; display:flex; gap:10px;">
                <button class="btn-outline" style="flex:1" onclick="cancelReview()">å–æ¶ˆ</button>
                <button class="btn-success" style="flex:2" onclick="confirmImport()">âœ… ç¢ºèªåŒ¯å…¥</button>
            </div>
        </div>
    </div>

    <div id="view-manage" class="view">
        <div class="nav-bar">
            <button class="btn-outline" onclick="backToStudy()">â† è¿”å›</button>
            <span style="font-weight: bold;">ğŸ“ å–®å­—åˆ—è¡¨</span>
            <div style="width:50px;"></div>
        </div>
        <div class="card-area" style="text-align: left; padding: 20px; display:block;">
             <div id="manage-list" style="max-height:500px; overflow-y:auto;"></div>
        </div>
    </div>

    <div id="view-host-lobby" class="view">
        <div class="nav-bar nav-bar-center">
            <button class="btn-outline" onclick="goDashboard()">â† è¿”å›</button>
            <span class="nav-bar-title">âš”ï¸ å»ºç«‹æˆ¿é–“</span>
        </div>
        <div class="card-area">
            <h3>ç­‰å¾…æŒ‘æˆ°è€…...</h3>
            <p style="color:#666;">è«‹å‘ŠçŸ¥å°æ‰‹ä»¥ä¸‹è™Ÿç¢¼ï¼š</p>
            <div style="background:#f1f2f6; padding:20px; border-radius:15px; margin:20px 0; font-family:monospace; font-size:2.5em; letter-spacing:5px; color:var(--primary); font-weight:bold;" id="host-id-display">...</div>
            <button class="btn-outline" onclick="copyHostId()">ğŸ“‹ è¤‡è£½è™Ÿç¢¼</button>
            
            <div id="host-status" style="color: #999; margin-top:20px; font-size:0.9em;">æ­£åœ¨é€£æ¥ä¼ºæœå™¨...</div>
            <div id="host-actions" style="display:none; margin-top:30px; animation: popIn 0.5s;">
                <p style="color:var(--success); font-weight:bold; font-size:1.2em;">å°æ‰‹å·²é€£æ¥ï¼æº–å‚™é–‹æˆ°ï¼</p>
                <button class="btn-primary btn-block" onclick="hostStartGame()" style="background: linear-gradient(45deg, #00b894, #00cec9);">ğŸš€ é–‹å§‹å°æˆ°</button>
            </div>
        </div>
    </div>

    <div id="view-join-lobby" class="view">
        <div class="nav-bar nav-bar-center">
            <button class="btn-outline" onclick="goDashboard()">â† å–æ¶ˆ</button>
            <span class="nav-bar-title">âš”ï¸ åŠ å…¥æˆ¿é–“</span>
        </div>
        <div class="card-area">
            <h3>è¼¸å…¥ 6 ä½æ•¸æˆ¿é–“è™Ÿç¢¼</h3>
            <input type="number" id="join-id-input" placeholder="ä¾‹å¦‚: 123456" autocomplete="off" style="font-size: 1.5em; letter-spacing: 2px;">
            <button class="btn-primary btn-block" id="btn-connect" onclick="joinGame()">ğŸ”— é€£ç·š</button>
            <div id="join-status" style="margin-top:20px; color:#888; font-weight:bold;"></div>
        </div>
    </div>

    <div id="view-online-battle" class="view">
        <div class="nav-bar">
            <button class="btn-danger" onclick="quitOnlineGame()">ğŸ³ï¸ æŠ•é™</button>
            <span style="font-weight: 800; color: var(--danger); letter-spacing:1px;">âš”ï¸ LIVE BATTLE</span>
            <div style="width: 50px;"></div> 
        </div>
        <div class="card-area" style="border: 2px solid var(--primary); box-shadow: 0 0 20px rgba(108, 92, 231, 0.2);">
            <div class="battle-header">
                <div class="health-bar-container">
                    <span class="avatar">ğŸ¦¸â€â™‚ï¸</span>
                    <div style="font-weight:bold; color:var(--primary); font-size:0.9em;">YOU</div>
                    <div class="health-track"><div class="health-fill" id="my-hp-bar"></div></div>
                </div>
                <div style="font-weight:900; font-size:2.5em; color:#dfe6e9; font-style:italic;">VS</div>
                <div class="health-bar-container opponent">
                    <span class="avatar">ğŸ¦¹</span>
                    <div style="font-weight:bold; color:var(--danger); font-size:0.9em;">RIVAL</div>
                    <div class="health-track"><div class="health-fill" id="op-hp-bar"></div></div>
                </div>
            </div>
            
            <div id="battle-game-area">
                <div style="font-size:0.8em; color:#999; margin-top:10px; letter-spacing:2px; font-weight:bold;">SPELL FAST!</div>
                <div class="chinese-meaning" id="battle-meaning" style="font-size:2.2em; margin:15px 0;">...</div>
                <div class="input-area"><input type="text" id="battle-input" placeholder="Type answer..." autocomplete="off" onkeydown="if(event.key==='Enter') checkBattleAnswer()"></div>
                <div id="battle-feedback" style="height:25px; font-weight:800; font-size:1.2em;"></div>
            </div>

            <div id="battle-result-area" style="display:none;">
                <h2 id="battle-final-title" style="font-size:3em; margin-bottom:10px;">WIN!</h2>
                <button class="btn-outline" onclick="goDashboard()">è¿”å›é¦–é </button>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-overlay">
    <div class="modal" id="modal-content"></div>
</div>

<div class="modal-overlay" id="celebration-overlay" style="z-index: 2500;">
    <div class="modal" id="celebration-modal">
        <span style="font-size:4em;">ğŸ‰</span>
        <h2 id="cel-title">æ­å–œï¼</h2>
        <p id="cel-msg"></p>
        <button class="btn-primary" onclick="closeCelebration()" style="width:100%;">Awesome!</button>
    </div>
</div>

<script>
    // --- 0. Config ---
    let userData = JSON.parse(localStorage.getItem('anki-single-data')) || { 
        username: 'Student', apiKey: '', groups: {}, 
        settings: { studyMode: 'flip', sm2_n1: 1, sm2_n2: 6, sm2_start_ef: 2.5, sm2_min_ef: 1.3 }
    };
    if(!userData.settings.sm2_n1) userData.settings.sm2_n1 = 1;
    if(!userData.settings.sm2_n2) userData.settings.sm2_n2 = 6;
    if(!userData.settings.sm2_start_ef) userData.settings.sm2_start_ef = 2.5;
    if(!userData.settings.sm2_min_ef) userData.settings.sm2_min_ef = 1.3;

    let currentGroup = null; let modalType = ''; let retryQueue = []; let currentImageBase64 = null; let tempGeneratedCards = []; 
    let comboCount = 0;
    let peer = null; let conn = null; let battleDeck = []; let battleIndex = 0; let myHp = 100; let opHp = 100; let isHost = false;
    let recognition = null; 
    let mySimpleId = '';

    // --- 1. Init ---
    function initApp() { if (!userData.username) userData.username = 'Student'; renderDashboard(); updateGreeting(); }
    function updateGreeting() { document.getElementById('user-greeting').innerText = 'Hi, ' + userData.username; }
    function editUserName() { const newName = prompt("è«‹è¼¸å…¥ä½ çš„åå­—ï¼š", userData.username); if (newName && newName.trim() !== "") { userData.username = newName.trim(); saveUserData(); updateGreeting(); } }
    function factoryReset() { if(confirm("è­¦å‘Šï¼šé€™å°‡åˆªé™¤æ‰€æœ‰å–®å­—å¡å’Œè¨­å®šï¼Œä¸”ç„¡æ³•å¾©åŸã€‚\n\nç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰è³‡æ–™å—ï¼Ÿ")) { localStorage.removeItem('anki-single-data'); location.reload(); } }
    function saveUserData() { localStorage.setItem('anki-single-data', JSON.stringify(userData)); }

    // --- COMBO SYSTEM ---
    function triggerCombo(count) {
        if (count < 2) return; const layer = document.getElementById('combo-layer'); const el = document.createElement('div'); el.className = 'combo-text';
        if (count < 5) { el.innerText = `${count} Combo!`; el.classList.add('combo-small'); } else if (count < 10) { el.innerText = `Super! ${count}`; el.classList.add('combo-medium'); } else { el.innerText = `MAX COMBO ${count} ğŸ”¥`; el.classList.add('combo-large'); }
        layer.appendChild(el); if (navigator.vibrate) navigator.vibrate(50); setTimeout(() => el.remove(), 800);
    }

    // --- HELPER: Get Stats for Current Mode ---
    function getCardStats(card, mode) {
        if (!card.progress) card.progress = {};
        if (!card.progress[mode]) {
            if (mode === 'flip' && (card.repetitions !== undefined)) {
                card.progress['flip'] = { repetitions: card.repetitions, interval: card.interval, efactor: card.efactor, nextReview: card.nextReview };
                delete card.repetitions; delete card.interval; delete card.efactor; delete card.nextReview;
            } else {
                card.progress[mode] = { repetitions: 0, interval: 0, efactor: userData.settings.sm2_start_ef, nextReview: 0 };
            }
        }
        return card.progress[mode];
    }

    // --- 2. Dashboard Render ---
    function renderDashboard() {
        const grid = document.getElementById('group-grid-display'); grid.innerHTML = '';
        const modeMap = { 'flip': 'ç¿»å¡', 'spell': 'æ‹¼å­—', 'speak': 'å£èªª' };
        const currentMode = userData.settings.studyMode || 'flip';
        document.getElementById('current-mode-display').innerText = modeMap[currentMode];

        Object.keys(userData.groups).forEach(groupName => {
            const cards = userData.groups[groupName];
            const cardCount = cards.length;
            let dueCount = 0; let masteredCount = 0;
            cards.forEach(c => {
                const stats = getCardStats(c, currentMode);
                if (stats.nextReview <= Date.now() && !retryQueue.find(r=>r.id===c.id)) dueCount++;
                if (stats.interval > 10) masteredCount++;
            });
            const progress = cardCount === 0 ? 0 : (masteredCount / cardCount) * 100;
            const div = document.createElement('div'); div.className = 'group-card';
            div.innerHTML = `
                <div class="card-header-row">
                    <div class="card-title-text" onclick="enterGroup('${groupName}')" style="cursor:pointer;">${groupName}</div>
                    <div class="card-tools">
                        <button class="tool-btn" onclick="exportDeck(event, '${groupName}')" title="åŒ¯å‡º">â¬‡ï¸</button>
                        <button class="tool-btn danger" onclick="deleteGroup(event, '${groupName}')" title="åˆªé™¤">âœ•</button>
                    </div>
                </div>
                <div onclick="enterGroup('${groupName}')" style="flex:1; cursor:pointer;">
                    <div style="font-size:0.85em; color:#666; text-align:left;">
                        <p style="margin:4px 0;">ğŸ“š ${cardCount} å¼µå¡ç‰‡</p>
                        <p style="margin:4px 0; font-weight:bold; color: ${dueCount > 0 ? 'var(--danger)' : '#aaa'}">â° ${dueCount} å¾…è¤‡ç¿’ <span style="font-weight:normal; font-size:0.8em; color:#999;">(${modeMap[currentMode]})</span></p>
                    </div>
                    <div style="width:100%; height:5px; background:#eee; border-radius:3px; margin-top:8px; overflow:hidden;">
                        <div style="height:100%; width:${progress}%; background:var(--success);"></div>
                    </div>
                </div>
                <button class="btn-duel" onclick="setupHostGame(event, '${groupName}')">âš”ï¸ é€£æ©Ÿå°æˆ° (Host)</button>
            `;
            grid.appendChild(div);
        });
        const addBtn = document.createElement('div'); addBtn.className = 'group-card add-group-card';
        addBtn.innerHTML = `<div style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; cursor:pointer;"><span style="font-size:2em;">+</span><span style="font-weight:bold; font-size:0.9em;">æ–°å¢ç¾¤çµ„</span></div>`;
        addBtn.onclick = () => showModal('group');
        grid.appendChild(addBtn);
    }

    // --- 3. Navigation ---
    function goDashboard() { switchView('view-dashboard'); renderDashboard(); if(peer) { peer.destroy(); peer = null; } comboCount = 0; if(recognition) recognition.stop(); }
    function switchView(id) { document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function enterGroup(gn) { 
        currentGroup = gn; retryQueue = []; comboCount = 0; 
        document.getElementById('current-group-name').innerText = gn; 
        document.getElementById('mode-study').style.display = 'block'; 
        document.getElementById('mode-add').style.display = 'none'; 
        resetModeBtn();
        renderStudy(); switchView('view-workspace'); 
    }
    
    // Helper to reset AI button
    function resetModeBtn() {
        const btn = document.getElementById('mode-btn');
        if(btn) {
            btn.innerText = 'âœ¨ AI æ™ºèƒ½æ–°å¢'; 
            btn.classList.remove('btn-danger'); 
            btn.classList.add('btn-primary');
            btn.style.display = 'block'; 
        }
    }
    
    // --- 4. Study Modes ---
    let studyCard = null; let isRetryMode = false;
    function toggleMode() {
        const modeDiv = document.getElementById('mode-study');
        const addDiv = document.getElementById('mode-add');
        const btn = document.getElementById('mode-btn');
        if (modeDiv.style.display !== 'none') {
            modeDiv.style.display = 'none'; addDiv.style.display = 'block'; btn.innerText = 'â† è¿”å›å­¸ç¿’'; btn.classList.remove('btn-primary'); btn.classList.add('btn-danger');
        } else {
            modeDiv.style.display = 'block'; addDiv.style.display = 'none'; btn.innerText = 'âœ¨ AI æ™ºèƒ½æ–°å¢'; btn.classList.remove('btn-danger'); btn.classList.add('btn-primary');
            renderStudy();
        }
    }
    
    function renderStudy() {
        const cards = userData.groups[currentGroup];
        const currentMode = userData.settings.studyMode || 'flip';
        document.getElementById('study-mode-label').innerText = (currentMode==='spell'?'æ‹¼å­—':(currentMode==='speak'?'å£èªª':'ç¿»å¡'));

        if (!cards || cards.length === 0) {
            document.getElementById('card-display').innerHTML = `<div style="color: #999;"><h3>ğŸ“­ é€™è£¡æ˜¯ç©ºçš„</h3><p>é»æ“Šä¸Šæ–¹ AI æŒ‰éˆ•æ–°å¢å–®å­—ï¼</p></div>`;
            return;
        }

        const now = Date.now();
        const dueCards = cards.filter(c => getCardStats(c, currentMode).nextReview <= now);
        
        if (dueCards.length > 0) { studyCard = dueCards[0]; isRetryMode = false; }
        else if (retryQueue.length > 0) { studyCard = retryQueue[0]; isRetryMode = true; }
        else {
            const display = document.getElementById('card-display');
            display.innerHTML = `<div style="color: var(--success);"><span style="font-size:4em;">ğŸ‰</span><h3>ä»Šæ—¥ç›®æ¨™é”æˆï¼</h3><p>ä¼‘æ¯ä¸€ä¸‹å§ï¼</p></div>`;
            document.getElementById('count-due').innerText = 0;
            document.getElementById('count-retry').innerText = 0;
            return;
        }
        document.getElementById('count-due').innerText = dueCards.length;
        document.getElementById('count-retry').innerText = retryQueue.length;
        
        const display = document.getElementById('card-display');
        const maskedSentence = studyCard.sentence.replace(new RegExp(studyCard.word, 'gi'), '_______');
        const retryHtml = isRetryMode ? `<div style="background:var(--danger); color:white; padding:5px 15px; border-radius:20px; font-size:0.8em; display:inline-block; margin-bottom:10px;">â†º éŒ¯é¡Œé‡ç·´</div>` : '';
        const etymContent = (typeof studyCard.etymology === 'object') ? (studyCard.etymology['zh'] || '') : studyCard.etymology;
        const etymHtml = etymContent ? `<div style="background:#fff3e0; padding:10px; border-radius:8px; margin-bottom:15px; font-size:0.9em; color:#e67e22;"><b>ğŸ’¡ è¨˜æ†¶åŠ©æ‰‹:</b> ${etymContent}</div>` : '';
        
        // Mode: FLIP
        if (currentMode === 'flip') {
            display.innerHTML = `
                ${retryHtml}
                <button id="flip-audio-btn" class="spell-audio-btn" style="display:none" onclick="playAudio('${studyCard.word}')">ğŸ”Š</button>
                <div class="chinese-meaning">${studyCard.meaning}</div>
                <div class="sentence" id="sentence-display">${maskedSentence}</div>
                <button id="btn-reveal-answer" class="btn-primary" style="width:100%; font-size:1.2em;" onclick="revealAnswer()">ğŸ‘€ é¡¯ç¤ºç­”æ¡ˆ</button>
                <div id="answer-section" style="display:none; margin-top:20px;">
                    <h2 style="color:var(--primary); font-size:2.5em; margin:10px 0;">${studyCard.word}</h2>
                    ${etymHtml}
                    <div style="display:flex; gap:10px; margin-top:15px;">
                        <button class="btn-danger" style="flex:1; padding:15px; border-radius:12px;" onclick="rateCard('hard')">ğŸ”´ ä¸ç†Ÿ (Fail)</button>
                        <button class="btn-warning" style="flex:1; background:var(--warning); color:#333; padding:15px; border-radius:12px;" onclick="rateCard('good')">ğŸŸ¡ æ™®é€š (Pass)</button>
                        <button class="btn-success" style="flex:1; padding:15px; border-radius:12px;" onclick="rateCard('easy')">ğŸŸ¢ ç°¡å–® (Easy)</button>
                    </div>
                </div>`;
        } 
        // Mode: SPELL
        else if (currentMode === 'spell') {
            display.innerHTML = `
                ${retryHtml}
                <button class="spell-audio-btn" onclick="playAudio('${studyCard.word}')">ğŸ”Š</button>
                <div class="chinese-meaning">${studyCard.meaning}</div>
                <div class="sentence" style="font-size:0.9em; padding:10px; margin-bottom:15px;">${maskedSentence}</div>
                <div class="input-area"><input type="text" id="user-input" autocomplete="off" placeholder="Type here..." onkeydown="if(event.key==='Enter') checkAnswer()"></div>
                <button id="check-btn" class="btn-primary" onclick="checkAnswer()">é€å‡º</button>
                <div id="answer-section" style="display:none; margin-top:20px;">
                    <h2 style="color:var(--primary); margin:10px 0;">${studyCard.word}</h2>
                    ${etymHtml}
                    <div class="sentence">${studyCard.sentence}</div>
                    <div style="display:flex; gap:10px; margin-top:15px;">
                        <button class="btn-danger" style="flex:1; padding:15px; border-radius:12px;" onclick="rateCard('hard')">ğŸ”´ ä¸ç†Ÿ (Fail)</button>
                        <button class="btn-warning" style="flex:1; background:var(--warning); color:#333; padding:15px; border-radius:12px;" onclick="rateCard('good')">ğŸŸ¡ æ™®é€š (Pass)</button>
                        <button class="btn-success" style="flex:1; padding:15px; border-radius:12px;" onclick="rateCard('easy')">ğŸŸ¢ ç°¡å–® (Easy)</button>
                    </div>
                </div>`;
            setTimeout(()=>document.getElementById('user-input').focus(), 100);
            playAudio(studyCard.word);
        }
        // Mode: SPEAK
        else if (currentMode === 'speak') {
            display.innerHTML = `${retryHtml}<div class="chinese-meaning" style="margin-bottom:10px;">${studyCard.meaning}</div><h3 style="color:var(--text-light); margin-bottom:30px;">${studyCard.word}</h3><div class="mic-container"><div class="mic-btn" id="mic-btn" onclick="toggleSpeech()">ğŸ¤</div><div class="mic-ring"></div></div><div style="font-size:0.9em; color:#999;" id="speak-status">Tap mic to speak</div><div class="score-box" id="speak-result"><div id="speak-feedback-title" style="font-weight:bold; font-size:1.2em; margin-bottom:5px;"></div><div style="font-size:0.9em; color:#666;">ä½ å”¸æˆ: <span id="speak-heard" style="font-weight:bold; color:var(--text);"></span></div><div class="score-bar-bg"><div class="score-bar-fill" id="speak-score-bar"></div></div><div id="speak-advice" style="font-size:0.85em; color:#888; margin-bottom:10px;"></div><div style="display:flex; gap:10px; margin-top:15px;"><button class="btn-danger" style="flex:1; padding:15px; border-radius:12px;" onclick="rateCard('hard')">ğŸ”´ ä¸ç†Ÿ (Fail)</button><button class="btn-warning" style="flex:1; background:var(--warning); color:#333; padding:15px; border-radius:12px;" onclick="rateCard('good')">ğŸŸ¡ æ™®é€š (Pass)</button><button class="btn-success" style="flex:1; padding:15px; border-radius:12px;" onclick="rateCard('easy')">ğŸŸ¢ ç°¡å–® (Easy)</button></div></div>`;
        }
    }

    // --- Speech Logic ---
    function toggleSpeech() {
        if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) { alert("ç€è¦½å™¨ä¸æ”¯æ´èªéŸ³è¾¨è­˜ (å»ºè­°ä½¿ç”¨ Chrome)"); return; }
        if (recognition && recognition.started) { recognition.stop(); return; }
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        recognition = new SpeechRecognition(); recognition.lang = 'en-US'; recognition.interimResults = false; recognition.maxAlternatives = 1;
        const btn = document.getElementById('mic-btn'); const status = document.getElementById('speak-status');
        recognition.onstart = () => { recognition.started = true; btn.classList.add('listening'); status.innerText = "Listening..."; };
        recognition.onend = () => { recognition.started = false; btn.classList.remove('listening'); status.innerText = "Processing..."; };
        recognition.onresult = (event) => { const transcript = event.results[0][0].transcript.toLowerCase(); evaluatePronunciation(transcript); };
        recognition.start();
    }
    function evaluatePronunciation(heardText) {
        const target = studyCard.word.toLowerCase(); heardText = heardText.trim().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g,"");
        const similarity = similarityRatio(target, heardText); const score = Math.round(similarity * 100);
        const resultBox = document.getElementById('speak-result'); const title = document.getElementById('speak-feedback-title'); const heardEl = document.getElementById('speak-heard'); const bar = document.getElementById('speak-score-bar'); const advice = document.getElementById('speak-advice');
        resultBox.style.display = 'block'; heardEl.innerText = heardText; bar.style.width = score + '%';
        if (score >= 100) { title.innerText = "ğŸŒŸ Excellent! (100%)"; title.style.color = "var(--success)"; advice.innerText = "å®Œç¾ç™¼éŸ³ï¼Native speaker level!"; comboCount++; triggerCombo(comboCount); } 
        else if (score >= 80) { title.innerText = "ğŸ‘ Good Job! (" + score + "%)"; title.style.color = "var(--primary)"; advice.innerText = "ç™¼éŸ³å¾ˆæ¨™æº–ï¼Œç¹¼çºŒä¿æŒï¼"; } 
        else if (score >= 50) { title.innerText = "ğŸ¤” Almost... (" + score + "%)"; title.style.color = "var(--warning)"; advice.innerText = `æœ‰äº›éŸ³ç¯€ä¸å¤ªæ¸…æ¥šï¼Œè©¦è‘—å†å”¸ä¸€æ¬¡ "${studyCard.word}"ã€‚`; } 
        else { title.innerText = "ğŸ’ª Keep Trying (" + score + "%)"; title.style.color = "var(--danger)"; advice.innerText = "æ²’æŠ“åˆ°é‡é»ï¼Œå†è©¦ä¸€æ¬¡ï¼Ÿ"; }
    }
    function similarityRatio(s1, s2) {
        let longer = s1; let shorter = s2; if (s1.length < s2.length) { longer = s2; shorter = s1; } const longerLength = longer.length; if (longerLength === 0) return 1.0;
        return (longerLength - editDistance(longer, shorter)) / parseFloat(longerLength);
    }
    function editDistance(s1, s2) {
        s1 = s1.toLowerCase(); s2 = s2.toLowerCase(); const costs = new Array(); for (let i = 0; i <= s1.length; i++) { let lastValue = i; for (let j = 0; j <= s2.length; j++) { if (i == 0) costs[j] = j; else { if (j > 0) { let newValue = costs[j - 1]; if (s1.charAt(i - 1) != s2.charAt(j - 1)) newValue = Math.min(Math.min(newValue, lastValue), costs[j]) + 1; costs[j - 1] = lastValue; lastValue = newValue; } } } if (i > 0) costs[s2.length] = lastValue; } return costs[s2.length];
    }

    function revealAnswer() { 
        // FIX: TARGET SPECIFIC ID to avoid hiding the AI button
        const btn = document.getElementById('btn-reveal-answer');
        if(btn) btn.style.display = 'none'; 
        
        document.getElementById('answer-section').style.display = 'block'; 
        const audioBtn = document.getElementById('flip-audio-btn');
        if(audioBtn) audioBtn.style.display = 'flex';
        
        document.getElementById('sentence-display').innerHTML = studyCard.sentence.replace(new RegExp(studyCard.word, 'gi'), `<b>${studyCard.word}</b>`); 
        playAudio(studyCard.word); 
    }
    function checkAnswer() {
        const input = document.getElementById('user-input'); const val = input.value.trim().toLowerCase();
        if (val === studyCard.word.toLowerCase()) { input.classList.add('correct'); comboCount++; triggerCombo(comboCount); playAudio(studyCard.word); } 
        else { input.classList.add('wrong'); comboCount = 0; if (!retryQueue.find(c => c.id === studyCard.id)) retryQueue.push(studyCard); }
        input.disabled = true; document.getElementById('check-btn').style.display = 'none'; document.getElementById('answer-section').style.display = 'block';
    }

    // --- SM-2 Core ---
    function rateCard(rating) {
        const now = Date.now(); const s = userData.settings; const currentMode = s.studyMode || 'flip'; const stats = getCardStats(studyCard, currentMode);
        let q = 0;
        if (rating === 'hard') { q = 0; stats.repetitions = 0; stats.interval = 1; comboCount = 0; if (!retryQueue.find(c => c.id === studyCard.id)) retryQueue.push(studyCard); if (retryQueue.length > 1) retryQueue.push(retryQueue.shift()); stats.nextReview = now; } 
        else {
            if (rating === 'good') q = 4; if (rating === 'easy') q = 5;
            if (stats.repetitions === 0) stats.interval = s.sm2_n1; else if (stats.repetitions === 1) stats.interval = s.sm2_n2; else stats.interval = Math.round(stats.interval * stats.efactor);
            stats.repetitions += 1; stats.efactor = stats.efactor + (0.1 - (5 - q) * (0.08 + (5 - q) * 0.02)); 
            if (stats.efactor < s.sm2_min_ef) stats.efactor = s.sm2_min_ef; 
            stats.nextReview = now + (stats.interval * 86400000);
        }
        saveUserData(); renderStudy();
    }

    // --- 5. Gemini API ---
    async function fetchGemini(key, payload, model) {
        const url = `https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${key}`;
        const resp = await fetch(url, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        const data = await resp.json(); if (data.error) throw new Error(data.error.message); return data;
    }
    function triggerImageUpload() { document.getElementById('img-input').click(); }
    function handleImageSelect(e) {
        const file = e.target.files[0]; if (!file) return;
        const reader = new FileReader(); reader.onloadend = () => { currentImageBase64 = reader.result.split(',')[1]; document.getElementById('img-preview').src = reader.result; document.getElementById('img-preview-container').style.display = 'block'; document.getElementById('btn-upload-img').innerText = "âœ… åœ–ç‰‡å·²é¸å–"; }; reader.readAsDataURL(file);
    }
    function clearImage() { currentImageBase64 = null; document.getElementById('img-input').value = ''; document.getElementById('img-preview-container').style.display = 'none'; document.getElementById('btn-upload-img').innerText = "ğŸ“¸ æ‹ç…§ / æƒæå–®å­—"; }
    
    async function generateCards() {
        const key = document.getElementById('api-key').value.trim() || userData.apiKey; const text = document.getElementById('words-input').value.trim(); const loading = document.getElementById('loading-msg');
        if (!key) return alert('è«‹è¼¸å…¥ API Key'); if (!text && !currentImageBase64) return alert('è«‹è¼¸å…¥æ–‡å­—æˆ–ä¸Šå‚³åœ–ç‰‡');
        userData.apiKey = key; saveUserData(); loading.style.display = 'block';
        const systemPrompt = `You are a vocabulary assistant. Analyze the input text or image. Extract English vocabulary words. Output STRICT JSON ONLY. Format: [ { "word": "english word", "meaning": "Traditional Chinese meaning", "sentence": "A simple English example sentence (B1 level)", "etymology": "A short explanation of origin/memory aid in Traditional Chinese" } ]`;
        let contentsPart = [{ text: systemPrompt + `\n\nInput: ${text ? text : "Extract from attached image"}` }];
        if (currentImageBase64) contentsPart.push({ inline_data: { mime_type: "image/jpeg", data: currentImageBase64 } });
        try {
            const data = await fetchGemini(key, { contents: [{ parts: contentsPart }] }, 'gemini-2.5-flash');
            let jsonStr = data.candidates[0].content.parts[0].text; jsonStr = jsonStr.replace(/```json/g, '').replace(/```/g, '');
            const start = jsonStr.indexOf('['); const end = jsonStr.lastIndexOf(']'); if (start !== -1 && end !== -1) jsonStr = jsonStr.substring(start, end + 1);
            try { tempGeneratedCards = JSON.parse(jsonStr); switchView('view-review'); renderReviewList(); } catch (e) { throw new Error("AI å›å‚³æ ¼å¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚"); }
            loading.style.display = 'none';
        } catch (e) { alert('AI Error: ' + e.message); loading.style.display = 'none'; }
    }
    function renderReviewList() {
        const list = document.getElementById('review-list'); list.innerHTML = '';
        tempGeneratedCards.forEach((card, index) => {
            const div = document.createElement('div'); div.style.cssText = "background:#f8f9fa; padding:15px; border-radius:12px; margin-bottom:10px; border:1px solid #eee; position:relative;";
            div.innerHTML = `<div style="position:absolute; right:10px; top:10px; color:#ff7675; cursor:pointer; font-weight:bold;" onclick="tempGeneratedCards.splice(${index},1);renderReviewList()">âœ•</div><label style="font-size:0.8em; color:#888;">å–®å­—</label><input type="text" value="${card.word}" style="width:100%; border:1px solid #ddd; padding:5px; border-radius:5px; margin-bottom:5px;" onchange="tempGeneratedCards[${index}].word=this.value"><label style="font-size:0.8em; color:#888;">é‡‹ç¾©</label><input type="text" value="${card.meaning}" style="width:100%; border:1px solid #ddd; padding:5px; border-radius:5px;" onchange="tempGeneratedCards[${index}].meaning=this.value">`;
            list.appendChild(div);
        });
    }
    function cancelReview() { 
        tempGeneratedCards = []; 
        switchView('view-workspace'); 
        resetModeBtn();
        document.getElementById('mode-study').style.display = 'block'; 
        document.getElementById('mode-add').style.display = 'none'; 
        renderStudy();
    }
    function confirmImport() {
        if (!userData.groups[currentGroup]) userData.groups[currentGroup] = [];
        tempGeneratedCards.forEach(c => { c.id = Date.now() + Math.random(); userData.groups[currentGroup].push(c); });
        saveUserData(); alert(`æˆåŠŸåŒ¯å…¥ ${tempGeneratedCards.length} å€‹å–®å­—!`); tempGeneratedCards = []; document.getElementById('words-input').value = ''; clearImage();
        
        document.getElementById('mode-study').style.display = 'block'; 
        document.getElementById('mode-add').style.display = 'none'; 
        resetModeBtn();
        renderStudy(); 
        switchView('view-workspace');
    }

    // --- 6. Manager ---
    function openManager() { renderManagerList(); switchView('view-manage'); }
    function backToStudy() { switchView('view-workspace'); renderStudy(); }
    function renderManagerList() {
        const list = document.getElementById('manage-list'); list.innerHTML = ''; const cards = userData.groups[currentGroup] || [];
        if (cards.length === 0) { list.innerHTML = '<p style="text-align:center;color:#999;">æ²’æœ‰å–®å­—</p>'; return; }
        cards.forEach((card, index) => {
            const div = document.createElement('div'); div.style.cssText = "background:#fff; padding:15px; border-radius:12px; margin-bottom:10px; border:1px solid #eee; display:flex; justify-content:space-between; align-items:center;";
            div.innerHTML = `<div><strong style="font-size:1.1em; color:var(--primary);">${card.word}</strong><div style="color:#555;">${card.meaning}</div></div><div style="display:flex; flex-direction:column; gap:5px;"><button class="btn-outline" style="padding:4px 8px; font-size:0.8em;" onclick="editCard(${index})">âœ</button><button class="btn-danger" style="padding:4px 8px;" onclick="deleteCard(${index})">âœ•</button></div>`;
            list.appendChild(div);
        });
    }
    function deleteCard(i) { if(confirm('ç¢ºå®šåˆªé™¤?')) { userData.groups[currentGroup].splice(i, 1); saveUserData(); renderManagerList(); } }
    function editCard(i) { const c = userData.groups[currentGroup][i]; const w = prompt("ä¿®æ”¹å–®å­—:", c.word); if(w) { c.word = w; saveUserData(); renderManagerList(); } }

    // --- 7. Online Battle ---
    function setupHostGame(e, gn) { e.stopPropagation(); currentGroup = gn; const g = userData.groups[gn]; if (!g || g.length < 1) return alert('ç¾¤çµ„æ˜¯ç©ºçš„'); isHost = true; switchView('view-host-lobby'); initPeer(true); }
    function openJoinLobby() { isHost = false; switchView('view-join-lobby'); }
    
    function initPeer(asHost) {
        const statusEl = isHost ? document.getElementById('host-status') : document.getElementById('join-status');
        statusEl.innerText = "æ­£åœ¨é€£æ¥ Peer ç¶²è·¯...";
        let myPeerId = null;
        if (asHost) {
            const simpleCode = Math.floor(100000 + Math.random() * 900000);
            mySimpleId = simpleCode.toString();
            myPeerId = 'anki-battle-' + mySimpleId;
            document.getElementById('host-id-display').innerText = mySimpleId;
        }
        if (peer) peer.destroy();
        peer = new Peer(myPeerId);
        peer.on('open', (id) => {
            statusEl.innerText = "ä¼ºæœå™¨é€£æ¥æˆåŠŸ! (ID: " + id + ")";
            if (!asHost) document.getElementById('btn-connect').disabled = false;
        });
        peer.on('connection', (c) => {
            if (isHost) {
                conn = c;
                setupConnection();
                document.getElementById('host-status').innerText = "å·²é€£æ¥!";
                document.getElementById('host-actions').style.display = 'block';
            }
        });
        peer.on('error', (err) => { alert("é€£ç·šéŒ¯èª¤: " + err.type); statusEl.innerText = "é€£ç·šå¤±æ•—ï¼Œè«‹é‡è©¦"; });
    }

    function copyHostId() { navigator.clipboard.writeText(mySimpleId).then(() => alert('è™Ÿç¢¼å·²è¤‡è£½: ' + mySimpleId)); }

    function joinGame() {
        const input = document.getElementById('join-id-input');
        const code = input.value.trim();
        if (code.length < 6) return alert("è«‹è¼¸å…¥ 6 ä½æ•¸è™Ÿç¢¼");
        const targetPeerId = 'anki-battle-' + code;
        document.getElementById('join-status').innerText = "æ­£åœ¨é€£ç·šåˆ°æˆ¿é–“ " + code + "...";
        if (!peer || peer.destroyed) {
            initPeer(false);
            peer.on('open', () => { conn = peer.connect(targetPeerId); setupConnection(); });
        } else { conn = peer.connect(targetPeerId); setupConnection(); }
    }

    function setupConnection() {
        conn.on('open', () => {
            if (!isHost) {
                document.getElementById('join-status').innerText = "æˆåŠŸåŠ å…¥! ç­‰å¾…æˆ¿ä¸»é–‹å§‹...";
                document.getElementById('btn-connect').style.display = 'none';
            }
        });
        conn.on('data', (data) => {
            if (data.type === 'START_GAME') { battleDeck = data.deck; startGamePlay(); }
            else if (data.type === 'HIT') { myHp -= 20; updateHealthBars(); if (myHp <= 0) { conn.send({ type: 'GAME_OVER', winner: 'OPPONENT' }); endOnlineGame(false); } }
            else if (data.type === 'GAME_OVER') { endOnlineGame(true); }
        });
    }

    function hostStartGame() { battleDeck = [...userData.groups[currentGroup]].sort(()=>0.5-Math.random()).slice(0, 10); conn.send({ type: 'START_GAME', deck: battleDeck }); startGamePlay(); }
    function startGamePlay() { battleIndex = 0; myHp = 100; opHp = 100; comboCount = 0; updateHealthBars(); switchView('view-online-battle'); document.getElementById('battle-result-area').style.display = 'none'; document.getElementById('battle-game-area').style.display = 'block'; nextBattleRound(); }
    function updateHealthBars() { const myBar = document.getElementById('my-hp-bar'); const opBar = document.getElementById('op-hp-bar'); myBar.style.width = myHp + '%'; opBar.style.width = opHp + '%'; if(myHp < 30) myBar.classList.add('danger'); else myBar.classList.remove('danger'); if(opHp < 30) opBar.classList.add('danger'); else opBar.classList.remove('danger'); }
    function nextBattleRound() { if (battleIndex >= battleDeck.length) battleIndex = 0; const card = battleDeck[battleIndex]; document.getElementById('battle-meaning').innerText = card.meaning; const input = document.getElementById('battle-input'); input.value = ''; input.disabled = false; input.focus(); document.getElementById('battle-feedback').innerText = ''; }
    function checkBattleAnswer() {
        const input = document.getElementById('battle-input'); const val = input.value.trim().toLowerCase(); const card = battleDeck[battleIndex];
        if (val === card.word.toLowerCase()) { opHp -= 20; updateHealthBars(); comboCount++; triggerCombo(comboCount); document.getElementById('battle-feedback').innerText = "HIT!"; document.getElementById('battle-feedback').style.color = "var(--success)"; conn.send({ type: 'HIT' }); if (opHp <= 0) { endOnlineGame(true); } else { battleIndex++; setTimeout(nextBattleRound, 500); } } 
        else { document.getElementById('battle-feedback').innerText = "MISS!"; document.getElementById('battle-feedback').style.color = "var(--danger)"; input.value = ''; input.classList.add('wrong'); comboCount = 0; setTimeout(()=>input.classList.remove('wrong'), 500); }
    }
    function endOnlineGame(win) { document.getElementById('battle-game-area').style.display = 'none'; document.getElementById('battle-result-area').style.display = 'block'; const title = document.getElementById('battle-final-title'); if (win) { title.innerText = "ğŸ† YOU WIN!"; title.style.color = "var(--warning)"; fireConfetti(); } else { title.innerText = "ğŸ’€ YOU LOSE..."; title.style.color = "#636e72"; } }
    function quitOnlineGame() { if(conn) conn.close(); goDashboard(); }

    // --- 8. Utils & Modal ---
    function triggerImport() { document.getElementById('file-import').click(); }
    function handleImport(event) {
        const file = event.target.files[0]; if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try { const imported = JSON.parse(e.target.result); Object.keys(imported.groups).forEach(k => { if (!userData.groups[k]) userData.groups[k] = []; userData.groups[k] = [...userData.groups[k], ...imported.groups[k]]; }); saveUserData(); renderDashboard(); alert('åŒ¯å…¥æˆåŠŸï¼'); } catch (err) { alert('æ ¼å¼éŒ¯èª¤'); }
        }; reader.readAsText(file);
    }
    function exportDeck(e, name) { e.stopPropagation(); const data = { groups: {} }; data.groups[name] = userData.groups[name]; const blob = new Blob([JSON.stringify(data)], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `anki_${name}.json`; a.click(); }
    function deleteGroup(e, name) { e.stopPropagation(); if (confirm(`åˆªé™¤ç¾¤çµ„ ${name}?`)) { delete userData.groups[name]; saveUserData(); renderDashboard(); } }
    function sendGmailReminder() { const subject = "Anki Flashcards Reminder"; const body = "Remember to study your flashcards today!"; window.open(`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`); }
    function playAudio(w) { if (!w) return; const audioUrl = `https://dict.youdao.com/dictvoice?audio=${encodeURIComponent(w)}&type=2`; const audio = new Audio(audioUrl); const p = audio.play(); if (p !== undefined) { p.catch((e) => { speakFallback(w); }); } }
    function speakFallback(text) { if (!('speechSynthesis' in window)) return; window.speechSynthesis.cancel(); const u = new SpeechSynthesisUtterance(text); u.lang = 'en-US'; u.rate = 0.9; const voices = window.speechSynthesis.getVoices(); const enVoice = voices.find(v => v.name.includes('Google US')) || voices.find(v => v.lang.includes('en-US')); if (enVoice) u.voice = enVoice; window.speechSynthesis.speak(u); }
    
    function showModal(type) {
        modalType = type; const m = document.getElementById('modal-overlay'); const c = document.getElementById('modal-content'); m.style.display = 'flex';
        if (type === 'group') {
            c.innerHTML = `
                <h3 style="margin-top:0; text-align:center;">æ–°å¢ç¾¤çµ„</h3>
                <input type="text" id="modal-input" autofocus placeholder="è¼¸å…¥åç¨±..." 
                    style="width:85%; display:block; margin:0 auto 20px auto; padding:12px; border:2px solid #dfe6e9; border-radius:50px; font-size:1.2em; text-align:center; box-shadow: inset 0 2px 5px rgba(0,0,0,0.03); outline:none;">
                <div style="display:flex; gap:10px; justify-content:center;">
                    <button class="btn-outline" style="flex:1" onclick="closeModal()">å–æ¶ˆ</button>
                    <button class="btn-primary" style="flex:1" onclick="submitModal()">å»ºç«‹</button>
                </div>`;
        } else if (type === 'settings') {
            const mode = userData.settings.studyMode;
            c.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="margin:0; color:var(--text);">âš™ï¸ ç³»çµ±è¨­å®š</h3>
                    <div style="font-size:1.2em; cursor:pointer;" onclick="closeModal()">âœ•</div>
                </div>
                <div class="text-left">
                    <div class="settings-section-title">ğŸ“– å­¸ç¿’æ¨¡å¼</div>
                    <div class="mode-options">
                        <label class="mode-opt"><input type="radio" name="mode-select" value="flip" ${mode==='flip'?'checked':''}><div class="mode-label"><span>ğŸ´</span><div>ç¿»å¡</div></div></label>
                        <label class="mode-opt"><input type="radio" name="mode-select" value="spell" ${mode==='spell'?'checked':''}><div class="mode-label"><span>âŒ¨ï¸</span><div>æ‹¼å­—</div></div></label>
                        <label class="mode-opt"><input type="radio" name="mode-select" value="speak" ${mode==='speak'?'checked':''}><div class="mode-label"><span>ğŸ¤</span><div>å£èªª</div></div></label>
                    </div>
                    <div class="settings-section-title">ğŸ§  è¨˜æ†¶æ¼”ç®—æ³• (SM-2)</div>
                    <div class="sm2-grid">
                        <div class="sm2-item"><label>åˆæ¬¡é–“éš” (å¤©)</label><input type="number" id="set-n1" value="${userData.settings.sm2_n1}" min="0.1" step="0.1"></div>
                        <div class="sm2-item"><label>äºŒæ¬¡é–“éš” (å¤©)</label><input type="number" id="set-n2" value="${userData.settings.sm2_n2}" min="1"></div>
                        <div class="sm2-item"><label>åˆå§‹è¼•é¬†åº¦ (EF)</label><input type="number" id="set-ef" value="${userData.settings.sm2_start_ef}" step="0.1"></div>
                        <div class="sm2-item"><label>æœ€å°è¼•é¬†åº¦ (EF)</label><input type="number" id="set-min-ef" value="${userData.settings.sm2_min_ef}" step="0.1"></div>
                    </div>
                </div>
                <button class="btn-primary" style="width:100%; margin-top:20px; font-size:1.1em;" onclick="saveSettings()">ğŸ’¾ å„²å­˜è¨­å®š</button>
            `;
        }
    }
    function saveSettings() {
        const radios = document.getElementsByName('mode-select'); let selectedMode = 'flip'; for (const r of radios) { if(r.checked) selectedMode = r.value; }
        userData.settings.studyMode = selectedMode;
        userData.settings.sm2_n1 = parseFloat(document.getElementById('set-n1').value);
        userData.settings.sm2_n2 = parseFloat(document.getElementById('set-n2').value);
        userData.settings.sm2_start_ef = parseFloat(document.getElementById('set-ef').value);
        userData.settings.sm2_min_ef = parseFloat(document.getElementById('set-min-ef').value);
        saveUserData(); closeModal(); renderDashboard(); 
    }
    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
    function submitModal() {
        if (modalType === 'group') { const v = document.getElementById('modal-input').value.trim(); if (!v) return; if (!userData.groups[v]) { userData.groups[v] = []; saveUserData(); renderDashboard(); } else { alert('åç¨±å·²å­˜åœ¨'); } }
        closeModal();
    }
    function closeCelebration() { document.getElementById('celebration-overlay').style.display = 'none'; }
    function fireConfetti() { const c = document.getElementById('confetti-canvas'); const x = c.getContext('2d'); c.width = window.innerWidth; c.height = window.innerHeight; const p = []; const cl = ['#f00', '#0f0', '#00f', '#ff0', '#0ff', '#f0f']; for(let i=0; i<300; i++) p.push({x: Math.random()*c.width, y: Math.random()*c.height-c.height, w: Math.random()*10+5, h: Math.random()*10+5, c: cl[Math.floor(Math.random()*cl.length)], d: Math.random()*5+2, a: Math.random()*Math.PI*2}); function d() { x.clearRect(0,0,c.width,c.height); p.forEach(e=>{ x.save(); x.translate(e.x,e.y); x.rotate(e.a); x.fillStyle=e.c; x.fillRect(-e.w/2,-e.h/2,e.w,e.h); x.restore(); e.y+=e.d; e.a+=0.1; if(e.y>c.height) e.y=-10; }); requestAnimationFrame(d); } d(); }

    initApp();
</script>
</body>
</html>