<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Flashcards (Custom Settings & Reset)</title>
    <style>
        :root {
            --primary: #6c5ce7;
            --primary-dark: #5b4cc4;
            --secondary: #00cec9;
            --success: #00b894;
            --warning: #fdcb6e;
            --danger: #d63031;
            --bg: #dfe6e9;
            --card-bg: #fff;
            --text: #2d3436;
            --root-text: #e17055;
            --fire: #ff7675;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg);
            margin: 0;
            padding: 20px;
            color: var(--text);
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        .container { width: 100%; max-width: 600px; position: relative; z-index: 1;}
        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999; }

        button { cursor: pointer; border: none; border-radius: 8px; font-family: inherit; transition: transform 0.1s, opacity 0.2s; }
        button:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; padding: 10px 20px; }
        .btn-danger { background: var(--danger); color: white; padding: 5px 10px; font-size: 0.8em;}
        .btn-outline { background: transparent; border: 1px solid var(--text); color: var(--text); padding: 5px 10px; }
        .btn-gmail { background: #ea4335; color: white; width: 100%; padding: 10px; margin-top: 10px; border-radius: 8px; font-weight: bold;} 
        .btn-block { width: 100%; padding: 12px; font-size: 1.1em; }
        .btn-reset { color: #999; background: none; font-size: 0.8em; text-decoration: underline; margin-top: 30px; }
        .btn-reset:hover { color: var(--danger); }
        
        .lang-switch { 
            position: fixed; bottom: 20px; right: 20px; font-size: 0.9em; z-index: 900;
            background: rgba(255, 255, 255, 0.9); box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            padding: 10px 15px; border-radius: 30px; font-weight: bold; border: 1px solid #ddd;
        }
        .lang-switch:hover { background: white; transform: translateY(-2px); }

        .view { display: none; animation: fadeIn 0.3s; }
        .view.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .login-card { background: var(--card-bg); padding: 40px; border-radius: 20px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .user-list { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; margin: 20px 0; }
        .user-chip { background: #eee; padding: 10px 20px; border-radius: 25px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 10px; }
        .user-chip:hover { background: #dcdcdc; }
        
        .dashboard-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 20px; }
        .streak-container { display: flex; flex-direction: column; align-items: flex-end; cursor: pointer; }
        .streak-badge { background: #fff; padding: 5px 15px; border-radius: 20px; color: var(--fire); font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.1); display: flex; align-items: center; gap: 5px; transition: transform 0.2s; }
        .streak-progress { width: 100%; height: 4px; background: #eee; margin-top: 5px; border-radius: 2px; overflow: hidden; }
        .streak-bar { height: 100%; background: var(--fire); width: 0%; transition: width 0.5s ease-out; }

        .group-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; }
        .group-card { background: var(--card-bg); padding: 20px; border-radius: 15px; text-align: center; box-shadow: 0 4px 6px rgba(0,0,0,0.05); cursor: pointer; transition: 0.2s; position: relative; border: 2px solid transparent; }
        .group-card:hover { transform: translateY(-3px); border-color: var(--primary); }
        .card-actions { position: absolute; top: 5px; right: 5px; display: flex; gap: 5px; }
        .action-icon { background: none; color: #ccc; font-size: 1.1em; padding: 2px; border-radius: 4px; }
        .action-icon:hover { background: #eee; color: var(--text); }
        .del-icon:hover { color: var(--danger); background: #fee; }

        .add-group-card { border: 2px dashed #ccc; background: none; display: flex; align-items: center; justify-content: center; flex-direction: column; color: #888; }
        .add-group-card:hover { border-color: var(--primary); color: var(--primary); background: rgba(108, 92, 231, 0.05); }
        .import-btn-area { margin-top: 15px; text-align: center; }
        
        .card-area { background: var(--card-bg); border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); padding: 30px; text-align: center; min-height: 350px; display: flex; flex-direction: column; justify-content: center; position: relative; }
        .nav-bar { background: white; padding: 10px; border-radius: 10px; display: flex; justify-content: space-between; margin-bottom: 15px; align-items: center; }
        .chinese-meaning { font-size: 1.6em; font-weight: bold; color: var(--text); margin: 20px 0; }
        .sentence { background: #f8f9fa; padding: 15px; border-left: 4px solid var(--primary); border-radius: 4px; margin-bottom: 25px; color: #555; font-style: italic; line-height: 1.5; }
        .etymology-box { background: #fff3e0; border: 1px solid #ffe0b2; color: var(--root-text); padding: 10px; border-radius: 8px; margin-bottom: 15px; font-size: 0.95em; display: inline-block; max-width: 90%; }
        .retry-tag { background: var(--danger); color: white; padding: 4px 12px; border-radius: 12px; font-size: 0.8em; margin-bottom: 10px; display: inline-block; animation: pulse 2s infinite; }
        .audio-btn { background: white; border: 2px solid var(--primary); color: var(--primary); border-radius: 50%; width: 50px; height: 50px; cursor: pointer; font-size: 1.4em; margin: 0 auto 20px auto; display: flex; justify-content: center; align-items: center; transition: 0.2s; }
        .audio-btn.playing { animation: pulse 1s infinite; }
        .input-area input, .settings-area input, .settings-area textarea, .modal input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 1em; }
        .input-area input.correct { border-color: var(--success); background-color: #e8f8f5; }
        .input-area input.wrong { border-color: var(--danger); background-color: #fdeaea; }
        .rating-btns { display: flex; gap: 10px; margin-top: 20px; }
        .rating-btns button { flex: 1; padding: 12px; font-weight: bold; color: white; }
        .btn-hard { background: var(--danger); }
        .btn-good { background: var(--warning); color: #333 !important; }
        .btn-easy { background: var(--success); }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal { background: white; padding: 25px; border-radius: 15px; width: 300px; text-align: center; position: relative;}
        
        #celebration-modal h2 { color: var(--primary); margin-top: 0; }
        #celebration-modal .emoji { font-size: 4em; display: block; margin: 10px 0; animation: bounce 1s infinite; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }

    </style>
</head>
<body>

<canvas id="confetti-canvas"></canvas>
<button class="lang-switch" onclick="toggleLanguage()">ğŸŒ ä¸­/En</button>

<div class="container">
    
    <div id="view-login" class="view active">
        <div class="login-card">
            <h1 style="color: var(--primary);" data-i18n="app_title">ğŸ‘©â€ğŸ« å¤šç”¨æˆ¶å–®å­—å¡</h1>
            <p data-i18n="select_user">è«‹é¸æ“‡ä½¿ç”¨è€…</p>
            <div class="user-list" id="user-list-display"></div>
            <button class="btn-outline" onclick="showModal('user')" data-i18n="add_user">+ æ–°å¢ä½¿ç”¨è€…</button>
            <br>
            <button class="btn-reset" onclick="factoryReset()">âš ï¸ å›å¾©åˆå§‹è¨­å®š (Reset App)</button>
        </div>
    </div>

    <div id="view-dashboard" class="view">
        <div class="dashboard-header">
            <div>
                <span id="welcome-msg" style="font-weight: bold; font-size: 1.2em;"></span>
                <div style="font-size: 0.8em; color: #666;" data-i18n="select_group">è«‹é¸æ“‡è¦ç·´ç¿’çš„ç¾¤çµ„</div>
                <button class="btn-outline" style="font-size:0.8em; margin-top:5px;" onclick="showModal('settings')">âš™ï¸ è¨­å®š (Settings)</button>
            </div>
            
            <div class="streak-container" onclick="editGoal()">
                <div class="streak-badge">ğŸ”¥ <span id="streak-count">0</span> / <span id="streak-goal-display">7</span> <span data-i18n="days">Days</span></div>
                <div class="streak-progress"><div class="streak-bar" id="streak-bar"></div></div>
                <div style="font-size:0.7em; color:#999; margin-top:2px;" data-i18n="tap_edit">é»æ“Šä¿®æ”¹ç›®æ¨™</div>
            </div>
        </div>
        
        <div class="group-grid" id="group-grid-display"></div>

        <div class="import-btn-area">
             <button class="btn-outline" onclick="triggerImport()">ğŸ“‚ <span data-i18n="btn_import">åŒ¯å…¥ç‰Œçµ„ (.json)</span></button>
             <input type="file" id="file-import" style="display: none;" accept=".json" onchange="handleImport(event)">
        </div>

        <button class="btn-gmail" onclick="sendGmailReminder()">ğŸ“§ <span data-i18n="btn_email">è¨­å®š Gmail å­¸ç¿’æé†’</span></button>
        <button class="btn-outline" onclick="logout()" data-i18n="logout" style="margin-top:10px; width:100%;">ç™»å‡º</button>
    </div>

    <div id="view-workspace" class="view">
        <div class="nav-bar">
            <button class="btn-outline" onclick="goDashboard()" data-i18n="back_dashboard">â† å›åˆ—è¡¨</button>
            <span id="current-group-name" style="font-weight: bold; color: var(--primary);"></span>
            <button class="btn-primary" onclick="toggleMode()" id="mode-btn" data-i18n="btn_ai_add">AI æ–°å¢</button>
        </div>

        <div id="mode-study">
            <div style="text-align: center; margin-bottom: 10px; color: #666; font-size: 0.9em;">
                <span data-i18n="stat_due">å¾…è¤‡ç¿’</span>: <span id="count-due" style="font-weight: bold;">0</span> | 
                <span data-i18n="stat_retry">é‡è©¦</span>: <span id="count-retry" style="color:var(--danger); font-weight:bold;">0</span>
            </div>
            <div class="card-area" id="card-display"></div>
        </div>

        <div id="mode-add" style="display: none;">
            <div class="card-area" style="text-align: left;">
                <h3>ğŸ¤– Gemini 2.5 Auto-Gen</h3>
                <label>API Key</label>
                <input type="password" id="api-key" placeholder="Paste API Key here">
                <label data-i18n="input_label">è¼¸å…¥è‹±æ–‡å–®å­—</label>
                <textarea id="words-input" rows="5" placeholder="e.g., resilience, ubiquitous"></textarea>
                <button class="btn-primary btn-block" onclick="generateCards()" style="margin-top: 15px;" data-i18n="btn_generate">ç”Ÿæˆä¸¦åŠ å…¥</button>
                <div id="loading-msg" style="display:none; text-align:center; color: var(--primary); margin-top:10px;" data-i18n="loading">åˆ†æä¸­...</div>
            </div>
        </div>
    </div>
</div>

<div class="modal-overlay" id="modal-overlay">
    <div class="modal" id="modal-content">
        </div>
</div>

<div class="modal-overlay" id="celebration-overlay" style="z-index: 1100;">
    <div class="modal" id="celebration-modal">
        <span class="emoji">ğŸ‰</span>
        <h2 data-i18n="congrats_title">ç›®æ¨™é”æˆï¼</h2>
        <p data-i18n="congrats_msg">æ­å–œä½ é”åˆ°é€£çºŒå­¸ç¿’ç›®æ¨™ï¼</p>
        <p style="font-size: 1.5em; font-weight: bold; color: var(--fire); margin: 10px 0;"><span id="cel-streak">7</span> <span data-i18n="days">Days</span></p>
        <button class="btn-primary" onclick="closeCelebration()" style="width:100%;">Keep Going! ğŸš€</button>
    </div>
</div>

<script>
    // --- 0. i18n ---
    const translations = {
        'zh': {
            'app_title': 'ğŸ‘©â€ğŸ« å¤šç”¨æˆ¶å–®å­—å¡', 'select_user': 'è«‹é¸æ“‡ä½¿ç”¨è€…', 'add_user': '+ æ–°å¢ä½¿ç”¨è€…',
            'select_group': 'é¸æ“‡ç¾¤çµ„', 'logout': 'ç™»å‡º', 'back_dashboard': 'â† å›åˆ—è¡¨',
            'btn_ai_add': 'AI æ–°å¢å–®å­—', 'btn_study': 'å›åˆ°å­¸ç¿’', 'stat_due': 'ä¸€èˆ¬è¤‡ç¿’', 'stat_retry': 'éŒ¯èª¤é‡è©¦',
            'input_label': 'è¼¸å…¥è‹±æ–‡å–®å­— (é€—è™Ÿæˆ–æ›è¡Œ)', 'btn_generate': 'ç”Ÿæˆä¸¦åŠ å…¥', 'loading': 'AI æ­£åœ¨åˆ†æå­—é¦–å­—å°¾...',
            'cancel': 'å–æ¶ˆ', 'confirm': 'ç¢ºå®š', 'hint_listening': 'è½åŠ›èˆ‡æ‹¼å¯«ç·´ç¿’', 'submit_ans': 'æäº¤ç­”æ¡ˆ',
            'rate_hard': 'å›°é›£ / ç­”éŒ¯ (åˆ—å…¥é‡è©¦)', 'rate_good': 'é‚„å¥½ (1å¤©)', 'rate_easy': 'ç°¡å–® (3å¤©)',
            'empty_group': 'ç¾¤çµ„æ˜¯ç©ºçš„', 'empty_desc': 'é»æ“Šå³ä¸Šè§’æ–°å¢å–®å­—ï¼', 'finished_title': 'ğŸ‰ å›åˆçµæŸï¼',
            'finished_desc': 'åšå¾—å¥½ï¼æ‰€æœ‰å–®å­—éƒ½å·²è¤‡ç¿’å®Œç•¢ã€‚', 'new_group_label': 'æ–°ç¾¤çµ„', 'cards_unit': 'å¼µå¡ç‰‡', 'due_unit': 'å¾…è¤‡ç¿’',
            'etymology_label': 'ğŸ§© è¨˜æ†¶åŠ©æ‰‹', 'days': 'å¤©', 'retry_tag': 'â†º å†æ¬¡å˜—è©¦', 'btn_email': 'é–‹å•Ÿ Gmail å¯„ä¿¡æé†’è‡ªå·±',
            'email_hint': 'é€™å°‡é–‹å•Ÿéƒµä»¶è‰ç¨¿ï¼Œè«‹æŒ‰ä¸‹å‚³é€ä»¥é¼“å‹µè‡ªå·±ï¼',
            'email_subject': 'ã€è‡ªæˆ‘æé†’ã€‘è©²èƒŒå–®å­—äº†ï¼ğŸ”¥',
            'email_body': 'è¦ªæ„›çš„æˆ‘ï¼š\n\nåˆ¥å¿˜äº†ä»Šå¤©ä¹Ÿè¦ä¸Šç·šèƒŒå–®å­—ï¼\nä½ ç›®å‰å·²ç¶“é€£çºŒå­¸ç¿’äº† {streak} å¤©ã€‚\n\nå …æŒä¸‹å»ï¼Œç©å°‘æˆå¤šï¼',
            'btn_import': 'åŒ¯å…¥ç‰Œçµ„ (.json)', 'import_success': 'æˆåŠŸåŒ¯å…¥ç¾¤çµ„: ', 'import_error': 'æª”æ¡ˆæ ¼å¼éŒ¯èª¤',
            'tap_edit': 'é»æ“Šä¿®æ”¹ç›®æ¨™', 'edit_goal_title': 'è¨­å®šé€£å‹ç›®æ¨™', 'congrats_title': 'ç›®æ¨™é”æˆï¼', 'congrats_msg': 'å¤ªæ£’äº†ï¼ä½ å·²ç¶“é”åˆ°äº†ä½ çš„ç›®æ¨™ï¼',
            'settings_title': 'è¤‡ç¿’é–“éš”è¨­å®š', 'label_good': 'Good (é‚„å¥½) å€ç‡', 'label_easy': 'Easy (ç°¡å–®) å€ç‡', 'reset_warn': 'è­¦å‘Šï¼šæ­¤æ“ä½œå°‡åˆªé™¤æ‰€æœ‰è³‡æ–™ä¸”ç„¡æ³•å¾©åŸã€‚ç¢ºå®šå—ï¼Ÿ'
        },
        'en': {
            'app_title': 'ğŸ‘©â€ğŸ« Flashcards App', 'select_user': 'Select User', 'add_user': '+ Add User',
            'select_group': 'Select Deck', 'logout': 'Logout', 'back_dashboard': 'â† Back',
            'btn_ai_add': 'AI Add Cards', 'btn_study': 'Back to Study', 'stat_due': 'Review', 'stat_retry': 'Retry Queue',
            'input_label': 'Enter Words', 'btn_generate': 'Generate', 'loading': 'AI Analyzing...',
            'cancel': 'Cancel', 'confirm': 'Confirm', 'hint_listening': 'Listening & Spelling', 'submit_ans': 'Check Answer',
            'rate_hard': 'Hard / Wrong (Retry Later)', 'rate_good': 'Good (1d)', 'rate_easy': 'Easy (3d)',
            'empty_group': 'Deck Empty', 'empty_desc': 'Add words to start!', 'finished_title': 'ğŸ‰ Session Complete!',
            'finished_desc': 'Great job! You finished all cards.', 'new_group_label': 'New Deck', 'cards_unit': 'Cards', 'due_unit': 'Due',
            'etymology_label': 'ğŸ§© Memory Aid', 'days': 'Days', 'retry_tag': 'â†º Retry Mode', 'btn_email': 'Open Gmail Reminder',
            'email_hint': 'This opens a draft. Send it to yourself for motivation!',
            'email_subject': '[Reminder] Time to study! ğŸ”¥',
            'email_body': 'Dear me,\n\nDon\'t forget to study your flashcards today!\nYou represent a {streak} day streak.\n\nKeep going!',
            'btn_import': 'Import Deck (.json)', 'import_success': 'Imported Deck: ', 'import_error': 'Invalid File Format',
            'tap_edit': 'Tap to edit goal', 'edit_goal_title': 'Set Streak Goal', 'congrats_title': 'Goal Reached!', 'congrats_msg': 'Amazing! You hit your streak goal!',
            'settings_title': 'Algorithm Settings', 'label_good': 'Good Multiplier', 'label_easy': 'Easy Multiplier', 'reset_warn': 'WARNING: This will delete ALL data. Irreversible. Are you sure?'
        }
    };

    let currentLang = localStorage.getItem('anki-lang') || 'zh';

    function updateLanguage() {
        document.querySelectorAll('[data-i18n]').forEach(el => {
            const key = el.getAttribute('data-i18n');
            if (translations[currentLang][key]) el.innerText = translations[currentLang][key];
        });
        const modeBtn = document.getElementById('mode-btn');
        if(modeBtn) {
             const isAdding = document.getElementById('mode-add').style.display === 'block';
             modeBtn.innerText = isAdding ? translations[currentLang]['btn_study'] : translations[currentLang]['btn_ai_add'];
        }
    }

    function toggleLanguage() {
        currentLang = currentLang === 'zh' ? 'en' : 'zh';
        localStorage.setItem('anki-lang', currentLang);
        updateLanguage();
        if(document.getElementById('view-dashboard').classList.contains('active')) renderDashboard();
        if(document.getElementById('view-workspace').classList.contains('active')) renderStudy();
    }

    // --- 1. Data Structure ---
    let users = JSON.parse(localStorage.getItem('anki-users-list')) || [];
    let currentUser = null;
    let currentGroup = null;
    let userData = null;
    let modalType = ''; 
    let retryQueue = []; 

    // --- 2. Login & Streak ---
    function initLogin() {
        switchView('view-login');
        const list = document.getElementById('user-list-display');
        list.innerHTML = '';
        users.forEach(user => {
            const div = document.createElement('div');
            div.className = 'user-chip';
            div.innerHTML = `<span onclick="login('${user}')">${user}</span><span class="del-user" onclick="deleteUser('${user}')">âœ•</span>`;
            list.appendChild(div);
        });
        updateLanguage();
    }

    function factoryReset() {
        const t = translations[currentLang];
        if(confirm(t.reset_warn)) {
            if(confirm("Final check: ALL DATA will be lost.")) {
                localStorage.clear();
                location.reload();
            }
        }
    }

    function login(username) {
        currentUser = username;
        // Check for settings object
        userData = JSON.parse(localStorage.getItem(`anki-data-${username}`)) || { apiKey: '', groups: {}, streak: 0, streakGoal: 7, lastLogin: null, settings: { goodMult: 2, easyMult: 3 } };
        // Ensure settings exist if migrating from old version
        if (!userData.settings) userData.settings = { goodMult: 2, easyMult: 3 };

        const justHitGoal = checkStreak(); 
        document.getElementById('welcome-msg').innerText = (currentLang === 'zh' ? 'å—¨ï¼Œ' : 'Hi, ') + currentUser;
        document.getElementById('api-key').value = userData.apiKey || '';
        retryQueue = [];
        renderDashboard();
        switchView('view-dashboard');
        if (justHitGoal) triggerCelebration();
    }

    function checkStreak() {
        const today = new Date().toDateString();
        const lastLogin = userData.lastLogin;
        let goalReached = false;
        if (lastLogin !== today) {
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            if (lastLogin === yesterday.toDateString()) {
                userData.streak += 1;
            } else {
                userData.streak = 1;
            }
            if (userData.streak === (userData.streakGoal || 7)) goalReached = true;
            userData.lastLogin = today;
            saveUserData();
        }
        return goalReached;
    }

    function logout() { currentUser = null; userData = null; retryQueue = []; initLogin(); }

    function deleteUser(username) {
        if(confirm(`Delete ${username}?`)) {
            users = users.filter(u => u !== username);
            localStorage.setItem('anki-users-list', JSON.stringify(users));
            localStorage.removeItem(`anki-data-${username}`);
            initLogin();
        }
    }
    
    // --- 2.5 UI & Modals ---
    function editGoal() {
        const t = translations[currentLang];
        const newGoal = prompt(t.edit_goal_title, userData.streakGoal || 7);
        if (newGoal && !isNaN(newGoal) && newGoal > 0) {
            userData.streakGoal = parseInt(newGoal);
            saveUserData();
            renderDashboard();
        }
    }

    function triggerCelebration() {
        const overlay = document.getElementById('celebration-overlay');
        document.getElementById('cel-streak').innerText = userData.streak;
        overlay.style.display = 'flex';
        fireConfetti();
    }
    function closeCelebration() { document.getElementById('celebration-overlay').style.display = 'none'; }
    function fireConfetti() {
        const canvas = document.getElementById('confetti-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        const pieces = []; const colors = ['#f00', '#0f0', '#00f', '#ff0', '#0ff', '#f0f'];
        for(let i=0; i<300; i++) pieces.push({x: Math.random()*canvas.width, y: Math.random()*canvas.height-canvas.height, w: Math.random()*10+5, h: Math.random()*10+5, c: colors[Math.floor(Math.random()*colors.length)], d: Math.random()*5+2, a: Math.random()*Math.PI*2});
        let animationId;
        function draw() {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            pieces.forEach(p => {
                ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.a); ctx.fillStyle = p.c; ctx.fillRect(-p.w/2, -p.h/2, p.w, p.h); ctx.restore();
                p.y += p.d; p.a += 0.1; if(p.y > canvas.height) p.y = -20;
            });
            animationId = requestAnimationFrame(draw);
        }
        draw();
        setTimeout(() => { cancelAnimationFrame(animationId); ctx.clearRect(0,0,canvas.width,canvas.height); }, 5000);
    }

    // --- 3. Dashboard ---
    function renderDashboard() {
        const grid = document.getElementById('group-grid-display');
        grid.innerHTML = '';
        const t = translations[currentLang];
        
        document.getElementById('streak-count').innerText = userData.streak;
        const goal = userData.streakGoal || 7;
        document.getElementById('streak-goal-display').innerText = goal;
        const percentage = Math.min(100, (userData.streak / goal) * 100);
        document.getElementById('streak-bar').style.width = percentage + '%';

        Object.keys(userData.groups).forEach(groupName => {
            const cardCount = userData.groups[groupName].length;
            const dueCount = userData.groups[groupName].filter(c => c.nextReview <= Date.now() && !retryQueue.find(r=>r.id===c.id)).length;
            const div = document.createElement('div');
            div.className = 'group-card';
            div.innerHTML = `
                <div class="card-actions">
                    <button class="action-icon" title="Export JSON" onclick="exportDeck(event, '${groupName}')">â¬‡ï¸</button>
                    <button class="action-icon del-icon" title="Delete" onclick="deleteGroup(event, '${groupName}')">Ã—</button>
                </div>
                <div onclick="enterGroup('${groupName}')">
                    <h3>${groupName}</h3>
                    <p>${cardCount} ${t.cards_unit}</p>
                    <p style="color: ${dueCount > 0 ? 'var(--danger)' : '#aaa'}">${dueCount} ${t.due_unit}</p>
                </div>
            `;
            grid.appendChild(div);
        });

        const addBtn = document.createElement('div');
        addBtn.className = 'group-card add-group-card';
        addBtn.innerHTML = `<span style="font-size:2em;">+</span><span>${t.new_group_label}</span>`;
        addBtn.onclick = () => showModal('group');
        grid.appendChild(addBtn);
        updateLanguage();
    }
    
    function exportDeck(e, groupName) {
        e.stopPropagation();
        const deckData = userData.groups[groupName];
        const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(deckData));
        const dlAnchorElem = document.createElement('a');
        dlAnchorElem.setAttribute("href", dataStr);
        dlAnchorElem.setAttribute("download", `${groupName}.json`);
        document.body.appendChild(dlAnchorElem); dlAnchorElem.click(); dlAnchorElem.remove();
    }

    function triggerImport() { document.getElementById('file-import').click(); }

    function handleImport(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const content = JSON.parse(e.target.result);
                if (!Array.isArray(content)) throw new Error("Invalid");
                let deckName = file.name.replace(/\.json$/i, '');
                const newName = prompt(currentLang==='zh' ? "è«‹è¼¸å…¥æ–°ç¾¤çµ„åç¨±" : "Name for new deck", deckName);
                if (!newName) return;
                if (userData.groups[newName]) { alert("Exists"); return; }
                userData.groups[newName] = content;
                saveUserData(); renderDashboard();
            } catch (err) { alert(translations[currentLang].import_error); }
        };
        reader.readAsText(file); event.target.value = '';
    }

    function sendGmailReminder() {
        const t = translations[currentLang];
        const subject = encodeURIComponent(t.email_subject);
        const body = encodeURIComponent(t.email_body.replace('{streak}', userData.streak));
        window.open(`mailto:?subject=${subject}&body=${body}`);
    }

    function enterGroup(groupName) {
        currentGroup = groupName; retryQueue = [];
        document.getElementById('current-group-name').innerText = groupName;
        document.getElementById('mode-study').style.display = 'block';
        document.getElementById('mode-add').style.display = 'none';
        renderStudy(); switchView('view-workspace'); updateLanguage();
    }

    function deleteGroup(e, groupName) {
        e.stopPropagation();
        if(confirm(`Delete group "${groupName}"?`)) { delete userData.groups[groupName]; saveUserData(); renderDashboard(); }
    }

    function goDashboard() { switchView('view-dashboard'); renderDashboard(); }

    // --- 4. Study Logic ---
    let studyCard = null;
    let isRetryMode = false;

    function renderStudy() {
        const t = translations[currentLang];
        const cards = userData.groups[currentGroup] || [];
        
        // Late Retry Logic: Prioritize normal due cards
        const dueCards = cards.filter(c => c.nextReview <= Date.now() && !retryQueue.find(r => r.id === c.id)).sort((a,b) => a.nextReview - b.nextReview);

        if (dueCards.length > 0) {
            studyCard = dueCards[0]; isRetryMode = false;
        } else if (retryQueue.length > 0) {
            studyCard = retryQueue[0]; isRetryMode = true;
        } else {
            const display = document.getElementById('card-display');
            if (cards.length === 0) display.innerHTML = `<div style="color: #999;"><h3>${t.empty_group}</h3><p>${t.empty_desc}</p></div>`;
            else display.innerHTML = `<div style="color: var(--success);"><h3>${t.finished_title}</h3><p>${t.finished_desc}</p></div>`;
            document.getElementById('count-due').innerText = 0; document.getElementById('count-retry').innerText = 0;
            return;
        }

        const currentDueCount = cards.filter(c => c.nextReview <= Date.now() && !retryQueue.find(r => r.id === c.id)).length;
        document.getElementById('count-due').innerText = currentDueCount;
        document.getElementById('count-retry').innerText = retryQueue.length;

        const display = document.getElementById('card-display');
        const escapedWord = studyCard.word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        const regex = new RegExp(escapedWord, 'gi');
        const maskedSentence = studyCard.sentence.replace(regex, '<span style="border-bottom: 2px solid #ccc; padding: 0 10px;">_______</span>');
        
        let etymContent = '';
        if (studyCard.etymology) {
            etymContent = (typeof studyCard.etymology === 'object') ? (studyCard.etymology[currentLang] || studyCard.etymology['en'] || '') : studyCard.etymology;
        }
        const etymologyHtml = etymContent ? `<div class="etymology-box"><b>${t.etymology_label}:</b> ${etymContent}</div>` : '';
        const retryHtml = isRetryMode ? `<div class="retry-tag">${t.retry_tag}</div>` : '';

        display.innerHTML = `
            ${retryHtml}
            <div style="font-size:0.9em; color:#999; margin-bottom:10px;">${t.hint_listening}</div>
            <button class="audio-btn" id="btn-play-audio" onclick="playAudio('${studyCard.word}')">ğŸ”Š</button>
            <div class="chinese-meaning">${studyCard.meaning}</div>
            <div class="sentence">${maskedSentence}</div>
            <div class="input-area"><input type="text" id="user-input" placeholder="..." autocomplete="off" onkeydown="if(event.key==='Enter') checkAnswer()"></div>
            <button class="btn-primary" id="check-btn" onclick="checkAnswer()" style="margin-top:15px; width:100%;">${t.submit_ans}</button>
            <div id="answer-section" style="display:none; margin-top:20px; border-top:1px solid #eee; padding-top:20px; animation: fadeIn 0.5s;">
                <div style="font-size:2em; font-weight:800; color:var(--primary); margin-bottom:5px;">${studyCard.word}</div>
                ${etymologyHtml}
                <div class="rating-btns">
                    <button class="btn-hard" onclick="rateCard('hard')">${t.rate_hard}</button>
                    <button class="btn-good" onclick="rateCard('good')">${t.rate_good}</button>
                    <button class="btn-easy" onclick="rateCard('easy')">${t.rate_easy}</button>
                </div>
            </div>
        `;
        setTimeout(() => document.getElementById('user-input').focus(), 100);
    }

    function checkAnswer() {
        const input = document.getElementById('user-input');
        const val = input.value.trim().toLowerCase();
        if (val === studyCard.word.toLowerCase()) {
            input.classList.add('correct'); playAudio(studyCard.word);
        } else {
            input.classList.add('wrong');
            if (!retryQueue.find(c => c.id === studyCard.id)) retryQueue.push(studyCard);
        }
        input.disabled = true;
        document.getElementById('check-btn').style.display = 'none';
        document.getElementById('answer-section').style.display = 'block';
    }

    function rateCard(rating) {
        const now = Date.now(); const oneDay = 24 * 60 * 60 * 1000;
        
        // è®€å–è‡ªè¨‚å€ç‡ (Use Custom Intervals)
        const settings = userData.settings || { goodMult: 2, easyMult: 3 };

        if (rating === 'hard') {
            studyCard.interval = 0;
            if (!retryQueue.find(c => c.id === studyCard.id)) retryQueue.push(studyCard);
            if (retryQueue.length > 1) retryQueue.push(retryQueue.shift()); 
        } else {
            if (isRetryMode) retryQueue = retryQueue.filter(c => c.id !== studyCard.id);
            let interval = studyCard.interval || 0;
            
            if (rating === 'good') {
                // å¦‚æœæ˜¯æ–°å¡ (0)ï¼Œè¨­ç‚º 1 å¤©ï¼Œå¦å‰‡ * å€ç‡
                interval = interval === 0 ? 1 : Math.round(interval * settings.goodMult * 10) / 10;
                studyCard.interval = interval; 
                studyCard.nextReview = now + (interval * oneDay);
            } else if (rating === 'easy') {
                interval = interval === 0 ? 3 : Math.round(interval * settings.easyMult * 10) / 10;
                studyCard.interval = interval; 
                studyCard.nextReview = now + (interval * oneDay);
            }
        }
        saveUserData(); renderStudy();
    }

    async function generateCards() {
        const key = document.getElementById('api-key').value.trim();
        const text = document.getElementById('words-input').value.trim();
        const loading = document.getElementById('loading-msg');
        if (!key || !text) return alert('API Key & Words required');
        
        userData.apiKey = key; saveUserData(); loading.style.display = 'block';
        const prompt = `You are an expert etymologist. Create a JSON array for these words: "${text}". Each object must have: 1. "word" (lowercase). 2. "meaning" (Traditional Chinese concise). 3. "sentence" (B1 level example sentence). 4. "etymology": An object with two keys "en" and "zh" explaining roots/prefix/suffix. Return ONLY raw JSON. No markdown.`;
        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            const data = await response.json();
            let jsonStr = data.candidates[0].content.parts[0].text;
            jsonStr = jsonStr.replace(/```json/g, '').replace(/```/g, '').trim();
            const newCards = JSON.parse(jsonStr);
            newCards.forEach(c => {
                userData.groups[currentGroup].push({
                    id: Date.now() + Math.random(), word: c.word, meaning: c.meaning, sentence: c.sentence, etymology: c.etymology, nextReview: Date.now(), interval: 0
                });
            });
            saveUserData(); alert(`Added ${newCards.length} cards!`);
            document.getElementById('words-input').value = ''; toggleMode(); renderStudy();
        } catch (e) { alert('Error: ' + e.message); } finally { loading.style.display = 'none'; }
    }

    function playAudio(word) {
        const btn = document.getElementById('btn-play-audio');
        if(btn) btn.classList.add('playing');
        const url = `https://ssl.gstatic.com/dictionary/static/sounds/oxford/${word.toLowerCase()}--_us_1.mp3`;
        const audio = new Audio(url);
        audio.onended = () => { if(btn) btn.classList.remove('playing'); };
        audio.onerror = () => {
            const u = new SpeechSynthesisUtterance(word); u.lang = 'en-US'; window.speechSynthesis.speak(u);
            if(btn) btn.classList.remove('playing');
        };
        audio.play().catch(() => audio.onerror());
    }

    function saveUserData() { if (currentUser) localStorage.setItem(`anki-data-${currentUser}`, JSON.stringify(userData)); }
    function switchView(id) { document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function toggleMode() {
        const studyDiv = document.getElementById('mode-study'); const addDiv = document.getElementById('mode-add');
        if (studyDiv.style.display !== 'none') { studyDiv.style.display = 'none'; addDiv.style.display = 'block'; }
        else { studyDiv.style.display = 'block'; addDiv.style.display = 'none'; renderStudy(); }
        updateLanguage();
    }
    
    // --- Modal Logic Updated for Settings ---
    function showModal(type) {
        modalType = type; 
        const modal = document.getElementById('modal-overlay'); 
        const content = document.getElementById('modal-content');
        const t = translations[currentLang];
        
        modal.style.display = 'flex';
        
        if (type === 'user' || type === 'group') {
            const title = (type === 'user') ? t.add_user : t.new_group_label;
            content.innerHTML = `
                <h3 id="modal-title">${title}</h3>
                <input type="text" id="modal-input" placeholder="" autofocus>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-outline" style="flex:1" onclick="closeModal()">${t.cancel}</button>
                    <button class="btn-primary" style="flex:1" onclick="confirmModal()">${t.confirm}</button>
                </div>
            `;
            setTimeout(() => document.getElementById('modal-input').focus(), 100);
        } else if (type === 'settings') {
            // Settings Form
            const good = userData.settings ? userData.settings.goodMult : 2;
            const easy = userData.settings ? userData.settings.easyMult : 3;
            content.innerHTML = `
                <h3 id="modal-title">${t.settings_title}</h3>
                <label style="display:block; text-align:left; font-size:0.9em;">${t.label_good} (x${good})</label>
                <input type="number" id="input-good" value="${good}" step="0.1" min="1.1">
                
                <label style="display:block; text-align:left; font-size:0.9em;">${t.label_easy} (x${easy})</label>
                <input type="number" id="input-easy" value="${easy}" step="0.1" min="1.1">
                
                <div style="display: flex; gap: 10px;">
                    <button class="btn-outline" style="flex:1" onclick="closeModal()">${t.cancel}</button>
                    <button class="btn-primary" style="flex:1" onclick="confirmModal()">${t.confirm}</button>
                </div>
            `;
        }
    }
    function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; }
    function confirmModal() {
        if (modalType === 'settings') {
            const good = parseFloat(document.getElementById('input-good').value);
            const easy = parseFloat(document.getElementById('input-easy').value);
            if(good && easy) {
                userData.settings = { goodMult: good, easyMult: easy };
                saveUserData();
                closeModal();
            }
            return;
        }
        
        const val = document.getElementById('modal-input').value.trim();
        if (!val) return;
        if (modalType === 'user') {
            if (!users.includes(val)) {
                users.push(val); localStorage.setItem('anki-users-list', JSON.stringify(users));
                localStorage.setItem(`anki-data-${val}`, JSON.stringify({ apiKey: '', groups: {}, streak: 0, streakGoal: 7, settings: {goodMult:2, easyMult:3} })); initLogin();
            } else { alert('User exists'); }
        } else if (modalType === 'group') {
            if (!userData.groups[val]) { userData.groups[val] = []; saveUserData(); renderDashboard(); } else { alert('Group exists'); }
        }
        closeModal();
    }
    initLogin();
</script>
</body>
</html>